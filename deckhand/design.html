<html>
<head>
<meta charset="UTF-8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="design.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./rasterizeHTML.allinone.js"></script>
</head>

<body>

<h2>DeckHand (v0.9.26)</h2>

<p>
    DeckHand is a pirate themed deck builder game for 2 to 4 players. There are <span id="nbCards"></span> cards in 
    the game with <span id="nbDesign"></span>  unique designs.
</p>

<div style="clear:both;padding-top:20px">

<div id="distribution"></div>
<!-- <button id="genPDF">Create MB Print compatible PDF</button> -->

</div>

<div style="display: flex;">
    <div class="booklet" id="face" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
                Set up <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 1/2</span>
            </h3>
         
             <ol>
                 <li>Gather about 20 Treasure tokens into a bank. We recommend using tokens instead of dice. Give 1 Treasure to each player.</li>
                 <li>
                    Each player receives a deck of 2 Fist Fight and 2 Celebrate.
                    Remove all remaining Fist Fight and Celebrate from the game.
                 </li>
                 <li>
                    Shuffle and form the supply deck with 11 cards per player (10 with 4 players). The rest are the refresh deck.
                </li>
                <li>
                    Put 6 cards from the refresh deck face up on the table as the supply. 
                    From now on, maintain 6 face-up cards by replacing them from the <b>supply</b> deck.
                 </li>
             </ol>

             <h3>Unfolding of the game</h3>

             <p>
                 A random player start, then each player in turn:
             </p>
         
             <ol>
                 <li>Apply effects that happen at the start of turn <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                 <li>Discard your hand <img class="rule-icon" src="icons/card-discard-yellow.svg" /> and draw 3 cards.</li>
                 <li>You have 2 of any actions during your turn which are:
                     <ol>
                         <li>Playing a card: Apply its effects <b>then</b> put it in your discard.</li>
                         <li>Buying a card from the supply: It goes in your discard.</li>
                     </ol>
                  </li>
                 <li>When your deck is empty <b>immediately</b> shuffle your discard into a new deck then resume any ongoing effect.
                 </li>
             </ol>
            </div>

             <div style="margin-bottom: 20px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%" />
                <p id="illustration">
                    1. Supply deck &nbsp;2. Refresh deck<br>
                    3. Supply &nbsp;
                    4. Hand + Treasures<br>
                    5. Your deck &nbsp;
                    6. Your discard
                </p>
            </div>
        </div>
    </div>
    <div class="booklet" id="back"  title="booklet-back">
        <div class="innerBooklet">
            <div>
            <h3 style="margin-top:0">
                General rules <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 2/2</span>
            </h3>
        
            <ol>
                <li>Treasures are the currency for purchasing supply cards. Card cost is indicated by the chest icon at the bottom right <img class="rule-icon" src="icons/chest.svg" />.</li>
                <li><img class="rule-icon" src="icons/card-discard-yellow.svg" />&nbsp;<img class="rule-icon" src="icons/bookmark-yellow.svg" /> Icons at the top left are reminders of triggered effects.</li>
                <li><b>+1 Card:</b> Draw a card from your deck immediately.</li>
                <li><b>+1 Action:</b> If it is your turn, you get to use 1 extra action.</li>
                <li><b>+1 Treasure:</b> Take a Treasure from the bank immediately.</li>
                <li><b>+1 Buy:</b> You may buy a card without using an action this turn.</li>
                <li><b>+1 Supply refresh</b>: You may put 1 supply card at the bottom of the refresh deck this turn. 
                    Replace it with a <b>refresh</b> deck card.</li>
                <li>+1 Discard: Discard a card immediately <img class="rule-icon" src="icons/card-discard-yellow.svg" />.</li>
                <li>Apply card effects <b>in the written order</b>.</li>
                <li>While being played, cards are not in your hand or discard.</li>
                <!-- <li>Cards have 3 possible types: Attack, Structure, Adventure.</li> -->
                <li>Text that says "you have" checks cards residing in your hand.</li>
                <li>You can only Discard cards from your hand.
                    <!-- Playing is not Discarding. -->
                    Arrange your discard pile face up to allow for examination at a glance.
                </li>
                <li>If an effect lacks the "target" keyword, nothing is targeted.</li>
                <li>Unless specified, revealed cards return to their original place. 
                    Revealing cards never empties a deck.</li>
                <li>When a deck/discard/hand is too small for an effect, it applies to any nonzero amount. 
                    You cannot own fewer than 4 cards.</li> <!-- ; any effect attempting to do so is canceled. -->
            </ol>
        
            <h3>End of the game</h3>
        
            <p>
                The game ends when the supply deck is empty. The current player finishes their turn, and the others
                take a final turn with only 1 starting action.
                Count the number of hooks in each deck <img class="rule-icon" src="icons/hook.svg" />. The player with 
                the most hooks wins. In case of a tie, the one with the most Treasures wins, followed by the one who ended the game.
            </p>
            </div>

            <!-- <p><b>Solo challenge</b>: Create a 22-card supply deck and remove one card each turn. Aim to achieve 30 victory points.</p> -->

            <div>
                Information and update: https://bit.ly/dk-h<br>
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace()">Download booklet face</button>
<button onclick="downloadBookletBack()">Download booklet back</button>

<div class="config">
    General config
    <label>Use jpg<input type="checkbox" onchange="updateFormat(this)"></label>
    <label>Zoom<input type="text" value="6.5" onchange="updateZoom(this)"></label>
    <label>MPC image format<input type="checkbox" checked onchange="outputFormat(this)"></label>
</div>


<!-- <div style="clear: both;">
    <img width="240" src="https://raw.githubusercontent.com/batiste/batiste.github.io/03451c0b33ddc125cb38a1750487a939a1397f1c/pirates-2/back.png">
    <img src="./back.png" width="240">
</div> -->

<p>
    <button onclick="selectAll(this)">Select All</button>
    <button onclick="generatePrintSheet(this)">Create Print Sheet PDF from selection</button>
    <button onclick="downloadSelection(this)">Download selection</button>
</p>

<div id="cards"></div>

</body>

<script>
    var cards = [

    {
            'title': 'Fist Fight',
            'text': '+1 Treasure.',
            'flavor': 'Pirate friendships start with a fight.',
            'img': 'attacks/fist-fight.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '1',
            'cost': '1',
            'amount': 2 * 4
        },

        {
            'title': 'Celebrate',
            'text': '+1 Treasure for each Celebrate you have.<br>+1 Supply refresh, you may draw a card.',
            'flavor': 'Lonely grog or shared laughter?',
            'img': 'adventures/celebrate.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '1',
            'cost': '1',
            'amount': 2 * 4
        },

        {
            'title': 'Tavern',
            'text': '+1 Card if you have an Adventure.<br>+1 Treasure if you have an Attack.<br>+1 Action if you have a Structure.',
            'flavor': 'The tavern unites thieves, rogues and scoundrels.',
            'img': 'adventures/tavern-3.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '1',
            'cost': '1',
            'amount': 2,
        },

        {
            'title': 'Quick Shot',
            'text': '+1 Treasure.<br>+1 Action if you have an Attack.',
            'flavor': `With pistol ablaze, she commands: Don’t let them regroup!`,
            'img': 'attacks/dual-pistol.png',
            'type': 'attack',
            'subtype': 'Attack',
            'cost': 1,
            'victory': 1,
            'amount': 2,
        },

        {
            'title': 'Poisoned Grog',
            'text': '+1 Treasure.<br>When Discarded: +1 Treasure.', // , add condition, if you have not treasure if too strong 
            'flavor': 'Sometimes, poison is slow-acting.',
            'img': 'attacks/pint.png',
            'type': 'attack',
            'subtype': 'Attack',
            'cost': 1,
            'victory': 1,
            'amount': 1,
            'discard': true,

        },

        {
            'title': 'Beach Bum',
            'text': '+1 Treasure.<br>+1 Treasure if you are one of the player that owns the least amount of cards.',
            'flavor': 'Rumors have it that he is the richest man in town.',
            'img': 'adventures/beach-bum.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '1',
            'cost': '1',
            'amount': 1,

        },

        {
            'title': 'Reverie',
            'text': '+1 Treasure.<br>If you are targeted by any effects from one card: Discard this card to cancel them.',
            'flavor-no-quotes': '“Harmony! Serenity!” he yawned, after his nap.',
            // 'reduced-font-size': '9.1px',
            'img': 'adventures/namaste.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '1',
            'cost': '1',
            'amount': 1,
        },

        {
            'title': 'Kung Fu Lessons',
            'text': '+1 Treasure, +1 Supply refresh.<br>Put 1 card from target player’s discard at the bottom of their deck.',
            'flavor': 'The tide, harness its power to your advantage!',
            // 'reduced-font-size': '9.1px',
            'img': 'adventures/kung-fu.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '1',
            'cost': '1',
            'amount': 1,
            // 'discard': 1,

        },

        {
            'title': 'Governor’s Wedding',
            'text': '+1 Treasure. On their next turn, target enemy gains +1 Buy and must give you a Treasure before their first buy.',
            'flavor': 'A sumptuous gift secure favors and influence.',
            'img': 'structures/wedding.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': 1,
            'victory': 1,
            'amount': 1,

        },

        {
            'title': 'Imperial Powder',
            'text': '+1 Treasure. If you lose ownership of this card: remove from the game a card from target enemy’s discard that cost 3 or less.',
            'flavor': 'WARNING: does not roll, shock, or sway.',
            'img': 'structures/powder-keg.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': 1,
            'victory': 1,
            'amount': 1,

        },

        {
            'title': 'Haggling',
            'text': '+1 Supply refresh, +1 Buy.<br>Your next buy this turn cost 1 less.',
            'flavor': 'At times, the tongue wields a sharper edge than the sword.',
            'img': 'attacks/haggling.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '1',
            'cost': '1',
            'amount': 1,
        },
    
        {
            'title': 'Alley Thief',
            'text': '+1 Treasure, +1 Supply refresh.:or:Steal a Treasure from another player.',
            'flavor': 'A fleeting shadow, your treasures vanish!',
            'img': 'attacks/thief.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '1',
            'cost': '1',
            'amount': 1,
        },


        {
            'title': 'Useless Totem',
            'text': 'Reveal this card from your hand: Change its type until discarded. It is not an action. It can be done once per turn at any time.',
            'flavor': 'The futile trinket grins, seemingly mocking you.',
            'img': 'structures/totem.png',
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '2',
            'cost': '1',
            'amount': 1
        },

        {
            'title': 'Council Hall',
            'text': 'An enemy chose a card from the supply and put it in your discard.',
            'flavor': 'Gold for a seat is wealth wasted on whispers.',
            'img': 'structures/council-hall.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': 2,
            'victory': 2,
            'amount': 1,

        },

        {
            'title': 'Typhoon',
            'text': '+2 Cards, +1 Discard, +1 Treasure. Everyone move a card from their discard or, if unable, top deck to their left neighbor’s discard.',
            'flavor': 'A Swirling chaos! A navigational nightmare!',
            'reduced-font-size': '9.3px',
            'img': 'adventures/tornado.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '2',
            'amount': 1,

        },

        {
            'title': 'Alchemy',
            'text': 'Discard any number of cards, get that many Treasures. +2 Card.',
            'flavor': 'Infused with fire, bending fate. What could possibly go awry?',
            'img': 'adventures/alchemist-2.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'cost': 2,
            'victory': 2,
            'amount': 1,

        },

        {
            'title': 'Emperor’s Caprice',
            'text': '+1 Supply refresh. An enemy chose 3 supply cards. You may apply the effects of one as if you just played it.',
            'flavor': 'In his royal hands, even your choices are illusion.',
            'img': 'attacks/emperor.png',
            'type': 'attack',
            'subtype': 'Attack',
            'cost': 2,
            'victory': 2,
            'amount': 1,

        },

        {
            'title': 'Card Mastery',
            'text': '+1 Action.<br>Put a card from your discard in your hand.<br>When Discarded: +1 Card.',
            'flavor': 'A flick of the wrist commands wonder and fear.',
            'img': 'adventures/magician.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '3',
            'amount': 1,
            'discard': true,

        },

        {
            'title': 'Spice Trade',
            'text': '+1 Treasure.<br>If this card is in your discard, the first Structure you buy each turn cost 1 less.',
            'flavor': 'Spices dance and blend, a taste of opulence.',
            'img': 'adventures/spice-trade.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '2',
            'amount': 1,

        },

        {
            'title': 'Hideout',
            'text': '+2 Cards, +1 Treasure.<br>When Discarded: you may put it back in your hand. Do it only once per draw.',
            'flavor': 'A haven to open a rum bottle and see it through.',
            'img': 'structures/hideout.png',
            'type': 'structure',
            'subtype': 'Structure',
            'discard': true,
            'cost': '2',
            'victory': '2',
            'amount': 1
        },

        {
            'title': 'Gold Mine',
            'text': `A chosen enemy pick a number. +3 Cards. If the total cost of the drawn cards is not that number: 
            reveal them, +1 Action.`,
            'flavor': 'Beneath the soil, lies dreams and despair.',
            'img': 'structures/gold-mine.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': '2',
            'victory': '2',
            //'discard': true,
            'amount': 1
        },


        {
            'title': 'Harbor Market',
            'text': '+2 Treasures.:or:+1 Treasure, +1 Buy.',
            'flavor': 'Secrets and stolen treasures traded here.',
            'img': 'structures/market-super-format.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': '2',
            'victory': '2',
            'amount': 2
        },

        {
            'title': 'Eternal Archive',
            'text': '+2 Treasures.<br>When discarded: you may shuffle your discard into your deck.',
            'flavor': 'The indomitable will rises again, defying adversity.',
            'img': '',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': '2',
            'victory': '2',
            'amount': 2,
            'discard': true,
        },

        {
            'title': 'Rum Factory',
            'text': '+2 Treasures. You may give a Treasure from the bank to everybody. If you do, everybody must Discard a card after their initial draw on their next turn.',
            'img': 'structures/rum-factory.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': '2',
            'victory': '2',
            'amount': 1,

        },

        {
            'title': 'Exploration',
            'text': '+1 Action if you have an Adventure.<br>+1 Card, +1 Treasure.',
            'flavor': 'Set sail, but not without a compass in hand.',
            'img': 'adventures/exploration.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'cost': '2',
            'victory': '2',
            'amount': 1
        },

        {
            'title': 'Treasure Map',
            'text': '+1 Treasure. Look at the top 3 cards of your deck. You may put any number of them into your discard and the rest on top of your deck in any order.',
            //'flavor': 'Riches await the keen-eyed adventurer..',
            'img': 'adventures/treasure-map.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'cost': '2',
            'victory': '2',
            'amount': 1
        },

        {
            'title': 'Going Ape',
            'text': '+1 Action, +1 Supply Refresh. If played from your hand, swap Going Ape or a card from your hand with a card of equal cost from the supply. The new card joins your hand.',
            'img': 'attacks/silverback.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '2',
            'cost': '2',
            'amount': 1
        },

        {
            'title': 'Ghost Crew',
            'text': '+1 Card, +1 Treasure. You may put this card on the top of its owner’s deck. +1 Action if there is more than 2 Attacks on the supply.',
            'img': 'attacks/ghost-crew.png',
            'flavor': 'Trade your mortal life, enjoy eternal retribution.',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '2',
            'cost': '2',
            'amount': 1
        },

        {
            'title': 'Haunted Cave',
            'text': '+2 Card.<br>+1 Treasure for each Attack in your hand.',
            'flavor': 'This place resonates with skeletal clatters. Fear not, for the pure-hearted and free of greed.',
            'img': 'attacks/infested-cave.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '2',
            'cost': '2',
            'amount': 1
        },

        {
            'title': 'Unyielding Waves',
            'text': '+1 Action. Move up to 3 cards from the discard of any number of target players to the bottom of their owner\'s deck.',
            'flavor': 'The forces of the roaring ocean cannot be fought.',
            'img': 'attacks/relentless-waves.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '2',
            'cost': '2',
            'amount': 1
        },

        {
            'title': 'Lost Expedition',
            'text': 'Remove a card from target player discard and lay 2 bank Treasures on it. When the discard is shuffled, take the Treasures and return the card to the new discard.',
            'img': 'adventures/lost-expedition-2.png',
            //'reduced-font-size': '9.0px',
            'type': 'adventure',
            'subtype': 'Adventure',
            'cost': '2',
            'victory': '2',
            'amount': 2
        },

        {
            'title': 'Extravagance',
            'text': '+2 Buy, +1 Supply refresh.:or:+1 Buy, +1 Treasure.',
            'flavor': 'Only one way to spend: lavishly and flamboyantly!',
            'img': 'adventures/extravagance-2.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '2',
            'amount': 1
        },

        {
            'title': 'Shipyard',
            'text': '+1 Treasure.<br>You can’t use more than 5 actions this turn.<br>+1 Action for each Structure in your discard.',
            'img': 'structures/shipyard.png',
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '2',
            'cost': '2',
            'amount': 1,

        },

        {
            'title': 'Walk the Plank',
            'text': 'Remove a card from your hand or discard from the game: Get Treasures equal to its cost. +2 Treasures.',
            'flavor': 'A dance on the plank or a delayed sentence?',
            'img': 'attacks/plank.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '3',
            'cost': '3',
            'amount': 2
        },

        {
            'title': 'Wind in Sails',
            'text': '+1 Card.<br>At the start of your turn, if this card is in your discard: Draw an extra card during your initial draw.',
            'img': 'adventures/wind.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '2',
            'amount': 1,
            'start': true,
        },

        {
            'title': 'Adventurer’s Guild',
            'text': '+1 Treasure for each Adventure on the supply but no more than 4.',
            'flavor': 'Where quests and bravery converge.',
            'img': 'structures/adventurer-center.png',
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '2',
            'cost': '2',
            'amount': 1,

        },

        {
            'title': 'End of the Rainbow',
            'text': '+1 Card.<br>At the start of your turn, if this card is in your discard, as well as an Attack and a Structure: +1 Action.',
            // 'flavor': 'A taunting mirage of unachievable dreams',
            'img': 'adventures/rainbow.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '2',
            'amount': 1,
            'start': true,

        },

        {
            'title': 'Bank Fortress',
            'text': '+2 Treasures.<br>When Discarded: +1 Action.',
            'flavor': 'Fortified against raiders, the bank safeguards against the mightiest of temptations.',
            'img': 'structures/bank-2.png',
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '2',
            'cost': '2',
            'amount': 1,
            'discard': true,

        },

        {
            'title': 'Seaside Citadel',
            'text': 'You can’t use more than 5 actions this turn.<br>+1 Card, +2 Actions.',
            'flavor': 'By the sea’s edge, the citadel beckons the intrepid in search of fortunes.',
            'img': 'structures/citadel-2.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': '3',
            'victory': '2',
            'amount': 1
        },

        {
            'title': 'Architect\'s Workshop',
            'text': '+1 Action, +1 Treasure. If you have a structure: +1 Buy.',
            'flavor': 'Meticulous plans and skilled craftsmanship bring grand visions to life',
            'img': 'structures/architect-workshop.png',
            'type': 'structure',
            'subtype': 'Structure',
            'cost': '3',
            'victory': '2',
            'amount': 1
        },

        {
            'title': 'Voodoo Curse',
            'text': 'Reveal the top 3 cards of target player’s deck. Put one in their discard, then apply its effects as if you just played it.',
            'flavor': 'With every step, the curse tightens its grip.',
            'img': 'attacks/spell.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '3',
            'cost': '3',
            'amount': 2
        },

        {
            'title': 'Smuggler’s Cache',
            'text': '+1 Treasure.<br>At the start of your turn, if this card is in your discard: +1 Treasure.',
            'flavor': 'Few can chart the course to the forbidden spoils.',
            'img': 'structures/smugglers-cache.png',
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '2',
            'cost': '3',
            'amount': 1,
            'start': true,
        },

        {
            'title': 'Gambling Addiction',
            'text': '+2 Supply refresh. If the supply has at least 4 cards of the same type: +3 Treasures.',
            'flavor': 'The allure of easy riches sealed his downfall.',
            'img': 'adventures/gambling.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '2',
            'amount': 1,

        },

        {
            'title': 'Desperate Chase',
            'text': 'You and an enemy reveal the top 3 cards from your decks. If you revealed more Attacks: \
            put a supply card that cost less than 5 in your discard.',
            //'reduced-font-size': '9.3px',
            //'flavor': 'Sails ablaze, cannons roar, a final duel in pursuit.',
            'img': 'attacks/chase-2.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '2',
            'cost': '2',
            'amount': 1,

        },

        {
            'title': 'Improvised Grenade',
            'text': 'Target player chose a card from their discard and remove it from the game.<br>When Discarded: apply this card effect to all players.',
            'img': 'attacks/grenade.png',
            //  'reduced-font-size': '9.2px',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '2',
            'cost': '2',
            'amount': 1,
            'discard': true,
        },

        {
            'title': 'Unguarded Graveyard',
            'text': '+1 Treasure.<br>At the start of your turn, if this card is in your discard: you may put a card from your discard at the bottom of your deck.',
            'img': 'structures/grave-robbers.png',
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '2',
            'cost': '3',
            'amount': 1,
            'start': true,

        },

        {
            'title': 'Bewitched Doll',
            'text': 'On target enemy’s next turn you play their first action. You make all the decisions arising from this action.', // <br>When Discarded: +1 Action.
            'flavor': "Destiny is a fickle concept.",
            'img': 'attacks/voodoo-doll.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '3',
            'cost': '3',
            'amount': 1,
            // 'discard': true,
        },

        {
            'title': 'Crooked Merchant',
            'text': 'Swap a card between your discard and target player’s discard as long as the cost difference is less than 2. Give a bank Treasure to the targeted player.',
            // 'flavor': 'The lure of wealth lead to deceptive deals.',
            'img': 'attacks/merchant.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '2',
            'cost': '3',
            'amount': 1,
        },

        {
            'title': 'Merfolk Mercenary',
            'text': 'Pay 1 Treasure to reveal the top 2 cards of the supply deck. Put one in your discard.',
            'flavor': 'Though she secures priceless treasures, is this abomination worth the bargain?',
            'img': 'adventures/merfolk-2.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '2',
            'cost': '3',
            'amount': 1
        },

        {
            'title': 'Kraken’s Fury',
            'text': 'Everybody discard their hand. Apply the effects of a card from any discard.',
            'flavor': 'Beware of the devourer of ships and souls.',
            'img': 'attacks/kraken.png',
            'type': 'attack',
            'subtype': 'Attack',
            'victory': '3',
            'cost': '4',
            'amount': 1
        },

        {
            'title': 'Skull island',
            'text': 'Every player reveals the top card of their deck: you may swap one with another from the supply as long as the cost difference is less than 3.',
            'img': 'structures/skull.png',
            //'reduced-font-size': true,
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '4',
            'cost': '4',
            'amount': 1
        },

        {
            'title': 'Treasure Hunt',
            'text': '+1 Action, +1 Buy,<br>+1 Card, +1 Treasure.',
            'flavor': 'An isle shrouded in mystery holds the key to immense wealth.',
            'img': 'adventures/hunt.png',
            'type': 'adventure',
            'subtype': 'Adventure',
            'victory': '3',
            'cost': '4',
            'amount': 1
        },

        {
            'title': 'The Grand Council',
            'text': '+2 Actions. Before the end of your turn, flip 4 supply cards face down.\
            These cards do not exist. Restore them at any time on your next turn.',
            // 'reduced-font-size': true,
            // 'flavor': 'Arbitrary decisions serve as displays of power.',
            'img': 'structures/grand-council.png',
            'type': 'structure',
            'subtype': 'Structure',
            'victory': '5',
            'cost': '5',
            'amount': 1,

        },

    ]

    all = []
    var j = 0;
    var amount = 0;
    var distribution = {'attack': 0, 'structure': 0, 'adventure': 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, nb_cards_necessary_total:(15 * 4 + 6 + 2)}

    cards.forEach((c) => {
        var extra = ""
        c['id'] = j;
        amount += c['amount'];
        if(j>1) {
            distribution[c['type']] += c['amount']
            distribution[c['cost']] += c['amount']
        }

        if(c['victory'] != undefined) {
            extra += `<span class="hook">${c['victory']}</span>
                <img class="hook-icon" src="icons/hook.svg" />`
        }

        if(c['cost'] != undefined) {
            extra += `<span class="cost">${c['cost']}</span>
                <img class="cost-icon" src="icons/chest.svg" />`
        }

        if(c['subtype'] != undefined) {
            extra += `<span class="subtype">${c['subtype']}</span>`
        }

        if(c['start'] != undefined) {
            extra += `<span class="start"><img src="icons/bookmark-yellow.svg" /></span>`
        }

        if(c['discard'] != undefined) {
            extra += `<span class="discard"><img src="icons/card-discard-yellow.svg" /></span>`
        }

        if(c['type'] == "attack") {
            extra += `<img class="attack-icon-1" src="icons/attack.svg" /><img class="attack-icon-2" src="icons/attack.svg" />`
        }

        if(c['type'] == "adventure") {
            extra += `<img class="tentacle-icon-1" src="icons/tentacle.svg" /><img class="tentacle-icon-2" src="icons/tentacle.svg" />`
        }

        if(c['type'] == "structure") {
            extra += `<img class="structure-icon-1" src="icons/structure.svg" /><img class="structure-icon-2" src="icons/structure.svg" />`
        }

        var flavor = ""
        if(c['flavor']){
            flavor = `<span class="separator"></span><span class="flavour">“${c['flavor']}”</span>`
        }
        if(c['flavor-no-quotes']){
            flavor = `<span class="separator"></span><span class="flavour">${c['flavor-no-quotes']}</span>`
        }

        var style = ""
        if (c['reduced-font-size']) {
            style = `style="font-size: ${c['reduced-font-size']}"`
        }

        c['text'] = c['text'].replace(':d:', '<img class="rule-icon" src="icons/card-discard-yellow.svg">')
        c['text'] = c['text'].replace(':ms:', '<span class="mini-separator"></span>')
        c['text'] = c['text'].replace(':st:', '<img class="rule-icon" src="icons/bookmark-yellow.svg" />')
        c['text'] = c['text'].replace(':or:', '<span class="OR"><span class="or-line-left"></span>Or<span class="or-line-right"></span></span>')
        


        var template = `
        <div class="card-container">
            <div class="card" id="card-${j}" title="${c['title']}">
                <div class="inner">
                    <div class="front type-${c['type']}"> 
                        <div class="frame"><div></div></div>
                        <img src="${c['img']}" class="bg" />
                        
                        <span class="title">${c['title']}</span>
                        <span class="text" ${style}>
                            <span class="innerText">${c['text']}</span>
                            ${flavor}
                        </span>
                        ${extra}

                        <div class="mpc">
                            <img src="mpc-no-border.png" />
                        </div>
                        <div class="mask"></div>
                    </div>
                    <div class="back">
                        <img src="back.png" />
                        <div class="mpc">
                            <img src="mpc.png" />
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="downloadCardButton(this)">Download #${j+1}, copies: ${c['amount']}</button><br>
            <label><input type="checkbox" id="check-pdf-${c['id']}" onclick="changePrintSelection(this)" data-card-id="${c['id']}"  ${c['pdf'] ? 'checked="true' : ''}">Part of print sheet</label>
        </div>
        `
        all.push(template)
        j++;
    })

    document.getElementById('nbCards').innerHTML = amount;
    document.getElementById('nbDesign').innerHTML = cards.length;
    
    document.getElementById('distribution').innerHTML = JSON.stringify(distribution, undefined, '\n');

    document.getElementById('cards').innerHTML = all.join('')

    var format = 'png'
    function updateFormat(e) {
        if (e.checked) {
            format = 'jpg'
        } else {
            format = 'png'
        }
    }

    var preparePrintClass = 'preparePrint';
    function outputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrint';
        } else { 
            preparePrintClass = 'preparePrintNotMPC';
        }
    }

    function download(url, title) {
        var a = document.createElement('a')
        a.href=url
        a.download=title+"."+format;
        document.body.appendChild(a)
        a.click()
        a.remove()
    }

    function changePrintSelection(e) {
        cards.forEach((card) => {
            if(card.id == parseInt(e.dataset.cardId, 10)) {
                card['pdf'] = e.checked
            }
        })
    }

    function downloadCardButton(e) {
        downloadCard(e.parentNode.querySelector('.card'))
    }

    function downloadCard(card, cb) {
        createCardImage(card, (canvas) => {
            var title = card.title.toLowerCase().replace(/\s/g, '-')
            if (format=='png') {
                img = canvas.toDataURL();
            } else {
                img = canvas.toDataURL("image/jpeg", 0.9)
            }
            download(img, title);
            console.log('download', title);
            cb && cb(title);
        })
    }

    function downloadBookletFace(e) {
        createBookletImage(document.getElementById('face'))
    }

    function downloadBookletBack(e) {
        createBookletImage(document.getElementById('back'))
    }

    function createCardImage(card, cb) {

        card.classList.add(preparePrintClass)

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0; background-color: transparent;}
                .card {zoom: 4; float: none; position: initial; margin: 0;}
            </style>
            
            ${card.outerHTML}`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas)
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            card.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
            cb && cb(canvas)
        }, function error(e) {
            console.log("Error on card", card.title)
        });
    }

    function createBookletImage(booklet, cb) {
        
        booklet.classList.add(preparePrintClass)

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0}
                .booklet {zoom: 6.5; float: none; position: initial; margin: 0;}
            </style>
            
            ${booklet.outerHTML}`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            var title = booklet.title.toLowerCase().replace(/\s/g, '-')
            download(canvas.toDataURL(), title);
            booklet.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
        })

    }


var toRender = 0;

function bindImage(element, card, cb) {
    if (card['canvas']) {
        return cb();
    }
    createCardImage(element, (canvas) => {
        card['canvas'] = canvas
        cb();
    })
}

function selectAll() { 
    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        card.pdf = true;
        document.getElementById('check-pdf-'+card['id']).checked = true
    }
}

function downloadSelection(e) {
    e.disable = true;
    var previous = e.innerHTML
    toRender = 0;
    cards_to_render = {}
    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        downloadCard(e, () => {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    var inter = setInterval(() => {
        if (queue.length > 0) {
            if (queue.length > 0 || Object.keys(rendering).length > 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            return
        }
        clearInterval(inter);
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 2000)
    }, 1000);
}

function generatePrintSheet(e) {
    e.disable = true;
    var previous = e.innerHTML
    e.innerHTML = 'Please wait'
    toRender = 0;
    var jsPDF = window.jspdf.jsPDF;
    // A4
    var doc = new jsPDF({
        unit: "mm",
        format: [297, 210],
    });

    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        bindImage(e, card, ()=> {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    e.innerHTML = 'Rendering...'

    var inter = setInterval(() => {

        if (queue.length > 0 || Object.keys(rendering).length > 0) {
            if (Object.keys(rendering).length == 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            console.log(rendering, queue.length)
            return
        }

        clearInterval(inter);
        e.innerHTML = `Card render pass done, now PDF page rendering.`

        var pageCounter = 0;
        for (i=0; i<cards.length; i++) {
            var card = cards[i];
            if (!card.pdf) {
                continue
            }
            e.innerHTML = 'Rendering page ' + card['title'];
            for (j=0; j<card.amount; j++) {
                if (pageCounter > 8) {
                    doc.addPage()
                    pageCounter = 0;
                }

                var y = (297 / 3.0) * Math.floor(pageCounter / 3.0)
                var x = (210 / 3.0) * (pageCounter % 3);
                doc.addImage(card.canvas, "PNG", x, y, 69, 94, card['title'], "FAST", 0)
                pageCounter += 1;
            }
        }

        doc.save("print.pdf");
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 500)
    }, 1000)
}

</script>
</html>