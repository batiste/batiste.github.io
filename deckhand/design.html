<html>
<head>
<meta charset="UTF-8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="design.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./rasterizeHTML.allinone.js"></script>
<script src="./cards.fr.js"></script>
<script src="./cards.en.js"></script>
</head>

<body>

<h2>DeckHand (v0.9.32)</h2>

<p>
    DeckHand is a pirate themed deck builder game for 2 to 4 players. There are <span id="nbCards"></span> cards in 
    the game with <span id="nbDesign"></span>  unique designs.
</p>

<div style="clear:both;padding-top:20px">

<div id="distribution"></div>
<!-- <button id="genPDF">Create MB Print compatible PDF</button> -->

</div>

<div style="display: flex;">
    <div class="booklet" id="face" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
                Set up for 2 to 4 players<span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 1/2</span>
            </h3>
         
             <ol>
                <li>Gather the 17 coin token cards into a bank. Distribute a 1 coin 
                    <img class="rule-icon coin" src="icons/coins.svg" /> token card 
                    to each player. From now on, let's call them coins.
                </li>
                <!-- <li>
                    To play a novice game (3 players max.), remove all card with the :Hard: from the game.
                </li> -->
                <li>
                    Provide a shuffled <b>deck</b> of 2 "Fist Fight" and 2 "Celebrate" to each player.
                    Remove all other "Fist Fight" and "Celebrate" from the game.
                </li>
                <li>
                    Shuffle and create the <b>supply deck</b> with 11 cards per player (10 with 4 players). The remaining cards constitute the <b>reload deck</b>.
                </li>
                <li>
                    Place 6 cards from the reload deck face up on the table to create the <b>supply</b>.
                    Maintain 6 face-up supply cards <b>at all times</b> by replacing them from the <b>supply deck</b>.
                 </li>
             </ol>

             <h3>Unfolding of the game</h3>

             <p>
                A random player starts. Each player takes turns, following these steps:
             </p>
         
             <ol>
                <li>Resolve any start-of-turn effects that might trigger <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                <li>Discard <img class="rule-icon" src="icons/card-discard-yellow.svg" /> your hand, if any, then draw 3 cards from your deck.
                    From now on, your discard pile is referred to as the <b>stash</b>.
                </li>
                <li>You then have 2 Actions that you can use in the following ways:
                    <ul>
                        <li>Play a card from your hand: Set the card aside, resolve its effects and any consequences, and <b>then</b> put the card into your stash.</li>
                        <li>Buy a card from the supply: Pay the cost 
                             indicated by the chest <img class="rule-icon" src="icons/chest-simplified.svg" /> at the bottom right
                             with coins <img class="rule-icon coin" src="icons/coins.svg" /> and put it into your stash.</li>
                     </ul>
                </li>
             </ol>
             <p style="margin-top:3px">
                If your deck is ever empty during the game, <b>immediately</b> shuffle your stash 
                into a new deck and resume any ongoing actions or effects.
             </p>
            </div>

             <div style="margin-bottom: 18px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%;" />
                <div id="illustration" style="width:140px">
                    <div style="width:67px">
                        1. Supply deck<br>
                        2. Reload deck<br>
                        3. Supply
                    </div>
                    <div style="width:82px;">
                        4. Your hand<br>
                        5. Your deck</br>
                        6. Your stash
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="booklet" id="back"  title="booklet-back">
        <div class="innerBooklet">
            <div>
            <h3 style="margin-top:0">
                General rules <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 2/2</span>
            </h3>
        
            <ol>
                <li>Line up your stash cards facing upwards, allowing all players to quickly identify them.
                    Do likewise with your coin tokens.
                </li>
                <li><b>+1 <img class="rule-icon coin" src="icons/coins.svg" />:</b> Take 1 coin from the bank immediately.</li>
                <li><b>+1 <img class="rule-icon draw" src="icons/card-draw-2.svg" />:</b> You may draw 1 card from your deck immediately.</li>
                <li><b>+1 <img class="rule-icon reload" src="icons/cycle-2.svg" />:</b> You may put 1 supply card at the bottom of the reload deck immediately. 
                    If you do, replace it with a <b>reload deck</b> card.</li>
                <li><b>+1 Action:</b> Gain 1 extra Action to use this turn. Do not use more than 5 Actions per turn.</li>
                <li><b>+1 Buy:</b> You may Buy 1 card without using an Action this turn.</li>
                <li><b>Pay 1 <img class="rule-icon coin" src="icons/coins.svg" />:</b> Put 1 of your coins into the bank.</li>
                <li><b>+1 Discard:</b> Discard 1 card from your hand into your stash.</li>

                <li>Resolve card effects <b>in the written order</b> before taking any other Actions or Buys.
                    If effects would trigger simultaneously, the initiator of 
                    the first effect decides the order in which they are resolved.</li>
                <!-- You may only gain and use <img class="rule-icon star" src="icons/star.svg" />, <img class="rule-icon star" src="icons/cycle-2.svg" /> or Buys during your turn. -->
                <li>You can only discard cards from your hand. Revealing or looking at cards doesn't  
                    add them to your hand or empties decks. Unless specified, revealed 
                    cards return to their original position <b>immediately</b>.</li>
                <li>If an effect cannot be fully applied, it still applies partially, to the extent possible.
                    However, You cannot select effects or targets that are not applicable.
                    You must always have a minimum of 4 cards.</li>
            </ol>


            <!-- <h4>
                Reminder symbols
            </h4>

            <p>
                The symbols <img class="rule-icon" src="icons/card-discard-yellow.svg" /> <img class="rule-icon" src="icons/bookmark-yellow.svg" /> 
                at the top left are reminders of triggered effects,
                while <img class="rule-icon" src="icons/target.svg" /> indicates targeted effects that affect enemies.
            </p> -->
            
                <!-- The hook icon on the bottom left <img class="rule-icon" src="icons/hook.svg" /> 
                indicates the victory points. -->
        
            <h3>End of the game</h3>
        
            <p>
                The game ends when the supply deck is empty. The current player finishes their turn, and the others
                take a final turn with only 1 starting Action.
                Count the number of hooks <img class="rule-icon" src="icons/hook-simplified.svg" /> in each deck. The player with the most
                hooks wins. In the case of a tie, the player with the most coins wins, followed by the player who ended the game.
            </p>

            </div>

            <div>
                The DeckHand box contains 90 cards and this booklet.<br>
                News, Solo Challenges and Beginner Rules: https://bit.ly/dk-h<br>
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace()">Download booklet face</button>
<button onclick="downloadBookletBack()">Download booklet back</button>


<div style="display: flex;">
    <div class="booklet booklet-fr" id="face-fr" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
                Mise en place pour 2 à 4 joueurs<span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Règles de DeckHand 1/2</span>
            </h3>
            
            <ol>
                <li>Rassemble 17 cartes Pièce en une banque. Donne 1 carte Pièce à chaque joueur. Désormais, apellons les simplement Pièces.</li>
                <li>
                    Fourni un <b>deck</b> mélangé de 2 Bagarre et 2 Célébration à chacun.
                    Retire toutes les autres cartes Bagarre et Célébration du jeu.
                </li>
                <li>
                    Mélange et forme le deck de <b>réserve</b> avec 11 cartes par joueur (10 avec 4 joueurs). Les autres cartes forment le deck de <b>recharge</b>.
                </li>
                <li>
                    Place 6 cartes du deck de recharge face visible sur la table comme réserve.
                    À partir de maintenant, maintient 6 cartes face visible à tout moment en les remplaçant depuis le deck de la <b>réserve</b>.
                </li>
            </ol>
            
            <h3>Déroulement du jeu</h3>
            
            <p>
                Un joueur aléatoire démarre, puis chacun son tour, suit ces étapes:
            </p>
            
            <ol>
                <li>Résoud les effets qui peuvent se produire au début du tour <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                <li>Défausse ta main <img class="rule-icon" src="icons/card-discard-yellow.svg" /> et pioche 3 cartes. Ta défausse se nomme désormais <b>planque</b></li>
                <li>Tu disposes de 2 Actions par tour, parmi lesquelles :
                    <ul>
                        <li>Jouer une carte : Mets la carte de coté, active ses effets et conséquences <b>puis</b> mets-la dans ta planque.</li>
                        <li>Achète une carte de la réserve : Paie le coût indiqué par le 
                            coffre <img class="rule-icon" src="icons/chest-simplified.svg" /> en bas à droite avec 
                            des pièces <img class="rule-icon coin" src="icons/coins.svg" /> 
                            et ajoute-la à ta planque.</li>
                    </ul>
                </li>
                <li>Lorsque ton deck est vide, mélange <b>immédiatement</b> ta planque pour former un nouveau deck, puis reprent tout effet en cours.
                </li>
            </ol>
            </div>

            <div style="margin-bottom: 18px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%;" />
                <div id="illustration" style="width:160px">
                    <div style="width:75px">
                        1. Deck réserve<br>
                        2. Deck recharge<br>
                        3. Réserve
                    </div>
                    <div style="width:88px;">
                        4. Ta main<br>
                        5. Ton deck</br>
                        6. Ta planque
                    </div>
                </div>
            </div>
            
            <!-- <div style="margin-bottom: 20px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%" />
                <p id="illustration">
                    1. Deck réserve &nbsp;2. Deck recharge<br>
                    3. Réserve &nbsp;
                    4. Main + Trésors<br>
                    5. Ton deck &nbsp;
                    6. Ta défausse
                </p>
            </div> -->
        </div>
    </div>

    
    <div class="booklet booklet-fr" id="back-fr"  title="booklet-back">
        <div class="innerBooklet">
            <div>
                <h3 style="margin-top:0">
                    Règles générales <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Règles de DeckHand 2/2</span>
                </h3>
            
                <ol>
                    <li>Aligne tes cartes de planque face vers le haut, permettant aux joueurs de les identifier rapidement.
                        Fait de même avec tes pièces.
                    </li>
                    <li><b>+1 <img class="rule-icon coin" src="icons/coins.svg" /> :</b> Prend immédiatement 1 pièce de la banque.</li>
                    <li><b>+1 <img class="rule-icon draw" src="icons/card-draw-2.svg" /> :</b> Tu peux immédiatement piocher 1 carte de ton deck.</li>
                    <li><b>+1 <img class="rule-icon reload" src="icons/cycle-2.svg" /> :</b> Tu peux immédiatement placer 1 carte de la réserve en bas 
                        du deck de recharge et la remplacer par une du <b>deck de recharge</b>.</li>
                    <li><b>+1 Action :</b> Gagne 1 Action supplémentaire à utiliser plus tard ce tour. N'utilise pas plus de 5 Actions par tour.</li>
                    <li><b>+1 Achat :</b> Achete 1 carte sans utiliser d'Action plus tard ce tour.</li>
                    <li><b>Paye 1 <img class="rule-icon coin" src="icons/coins.svg" /> :</b> Place 1 de tes pièces dans la banque.</li>
                    <li><b>+1 Défausse :</b> Défausse 1 carte de ta main dans ta planque.</li>
                    <li>Résous l'effets des cartes <b>dans l'ordre écrit</b>. Si ils se déclenchent simultanément,
                        l'initiateur du premier effet décide de l'ordre.</li>
                    <li>Tu ne peux défausser que des cartes de ta main. Révéler ou regarder des cartes 
                        ne les place pas dans ta main ni ne vide un deck. Sauf mention contraire, les cartes 
                        révélées retournent à leur position d'origine <b>immédiatement</b>.</li>
                    <li>Si un effet ne peut pas être pleinement appliqué, il s'applique autant que possible. Évite cependant les effets ou cibles inapplicables. 
                        Tu ne peux pas posséder moins de 4 cartes.</li>
                </ol>

                <h3>Fin du jeu</h3>
                
                <p>
                    Le jeu se termine lorsque le deck de réserve est vide. Le joueur actuel termine son tour, et les autres joueurs
                    effectuent un dernier tour avec seulement 1 action de départ.
                    Compte les crochets de chaque deck <img class="rule-icon" src="icons/hook.svg" />. Le joueur avec
                    le plus de crochets gagne. En cas d'égalité, celui ayant le plus de pièces gagne, suivi de celui qui a mis fin au jeu.
                </p>
            </div>
        
            <div>
                La boîte de DeckHand contient 90 cartes et ce livret.<br>
                Actualités, défis en solo et règles pour débutants : https://bit.ly/dk-h<br>
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace('face-fr')">Download booklet face</button>
<button onclick="downloadBookletBack('back-fr')">Download booklet back</button>


<p>
    <a href="./design.html">English</a>
    <a href="./design.html?lang=fr">French</a>    
</p>

<div class="config">
    General config
    <label>Use jpg<input type="checkbox" onchange="updateFormat(this)"></label>
    <label>Zoom<input type="text" value="6.5" onchange="updateZoom(this)"></label>
    <label>MPC image format<input type="checkbox" checked onchange="outputFormat(this)"></label>
    <label>PnP mask for easy cuts<input type="checkbox" onchange="PNPoutputFormat(this)"></label>
</div>


<!-- <div style="clear: both;">
    <img width="240" src="https://raw.githubusercontent.com/batiste/batiste.github.io/03451c0b33ddc125cb38a1750487a939a1397f1c/pirates-2/back.png">
    <img src="./back.png" width="240">
</div> -->

<p>
    <button onclick="selectAll(this)">Select All</button>
    <button onclick="generatePrintSheet(this)">Create Print Sheet PDF from selection</button>
    <button onclick="downloadSelection(this)">Download selection</button>
</p>

<div id="cards" class="lang-fr"></div>

<!-- class="lang-fr" -->

</body>

<script>


    all = []
    var j = 0;
    var amount = 0;
    var distribution = {'attack': 0, 'structure': 0, 'adventure': 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, nb_cards_necessary_total:(15 * 4 + 6 + 2)}

    var translations = cards.map(e => ({"title": e.title, "text": e.text, "flavor": e.flavor}))
    console.log(JSON.stringify(translations, null, 2))

    var lang = 'en';
    if (location.href.split('?').length > 1) {
        params = new URLSearchParams(location.href.split('?')[1])
        lang = params.get('lang')
    }
    var translation = {'fr': fr_translations}
    var type_translation = {
        'en': {
            'attack': 'Attack',
            'adventure': 'Adventure',
            'structure': 'Structure',
            'coin': 'Coin',
            'rule': 'Rules',
        },
        'fr': {
            'attack': 'Attaque',
            'adventure': 'Aventure',
            'structure': 'Structure',
        }
    }

    cards.forEach((c) => {
        var extra = ""
        c['id'] = j;
        amount += c['amount'];

        if (lang && translation[lang]) {
            var t = translation[lang]
            if(t[j]) {
                c['title'] = t[j]['title']
                c['text'] = t[j]['text']
                c['flavor'] = t[j]['flavor']
                c['flavor-no-quotes'] = t[j]['flavor-no-quotes']
            }
        }

        if(j>1) {
            distribution[c['type']] += c['amount']
            distribution[c['cost']] += c['amount']
        }

        if(c['victory'] != undefined) {
            extra += `<span class="hook">${c['victory']}</span>
                <img class="hook-icon" src="icons/hook.svg" />`
        }

        if(c['cost'] != undefined) {
            extra += `<span class="cost">${c['cost']}</span>
                <img class="cost-icon" src="icons/chest.svg" />`
        }

        if(c['type'] != undefined) {
            extra += `<span class="subtype">${type_translation[lang][c['type']]}</span>`
        }

        var top_left = '';

        if(c['start'] != undefined) {
            top_left += `<span class="start"><img src="icons/bookmark-yellow.svg" /></span>`
        }

        if(c['discard'] != undefined) {
            top_left += `<span class="discard"><img src="icons/card-discard-yellow.svg" /></span>`
        }

        if(c['target'] != undefined) {
            top_left += `<span class="target"><img src="icons/target.svg" /></span>`
        }

        if(c['coin'] != undefined) {
            top_left += `<span class="coin-top-left">${c['coin']}<img src="icons/coins.svg" /></span>`
        }

        if (top_left) {
            extra += `<span class="top-left-icons-container">${top_left}</span>`
        }

        if(c['type'] == "attack") {
            extra += `<img class="attack-icon-1" src="icons/attack.svg" /><img class="attack-icon-2" src="icons/attack.svg" />`
        }

        if(c['type'] == "adventure") {
            extra += `<img class="tentacle-icon-1" src="icons/tentacle.svg" /><img class="tentacle-icon-2" src="icons/tentacle.svg" />`
        }

        if(c['type'] == "structure") {
            extra += `<img class="structure-icon-1" src="icons/structure.svg" /><img class="structure-icon-2" src="icons/structure.svg" />`
        }

        var flavor = ""
        if(c['flavor']){
            flavor = `<span class="separator"></span><span class="flavour">“${c['flavor']}”</span>`
        }
        if(c['flavor-no-quotes']){
            flavor = `<span class="separator"></span><span class="flavour">${c['flavor-no-quotes']}</span>`
        }

        var style = ""
        if (c['reduced-font-size']) {
            style = `style="font-size: ${c['reduced-font-size']}"`
        }

        var or_txt = 'Or'
        if (lang == 'fr') {
            or_txt = 'Ou'
        }

        c['text'] = c['text'].replace(':d:', '<img class="rule-icon" src="icons/card-discard-yellow.svg">')
        c['text'] = c['text'].replace(':ms:', '<span class="mini-separator"></span>')
        c['text'] = c['text'].replace(':st:', '<img class="rule-icon" src="icons/bookmark-yellow.svg" />')
        c['text'] = c['text'].replace(':or:', `<span class="OR"><span class="or-line-left"></span>${or_txt}<span class="or-line-right"></span></span>`)
        

        function rep(key) {
            c['text'] = c['text'].replace(new RegExp(`\\+2 :${key}:`, 'g'), `<span class="keyword">+2 ${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`\\+3 :${key}:`, 'g'), `<span class="keyword">+3 ${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`4 :${key}:`, 'g'), `4 <span class="keyword">${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`5 :${key}:`, 'g'), `5 <span class="keyword">${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`\\+1 :${key}:`, 'g'), `<span class="keyword">+1 ${key}</span>`)
            c['text'] = c['text'].replace(new RegExp(`:${key}:`, 'g'), `<span class="keyword">${key}</span>`)
        }

        c['text'] = c['text'].replace(/Pay 1 :Coin:/g, `<span class="keyword">Pay 1</span> <img class="rule-icon chest" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/Paye 1 :Coin:/g, `<span class="keyword">Paye 1</span> <img class="rule-icon chest" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/\+1 :Buy:/g, `<span class="keyword">+1 Buy</span>`)
        c['text'] = c['text'].replace(/\+2 :Buy:/g, `<span class="keyword">+2 Buys</span>`)

        c['text'] = c['text'].replace(/\+1 :Coin:/g, `<span class="keyword">+1</span> <img class="rule-icon chest" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/\+2 :Coin:/g, `<span class="keyword">+2</span> <img class="rule-icon chest" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/\+3 :Coin:/g, `<span class="keyword">+3</span> <img class="rule-icon chest" src="icons/coins.svg" />`)

        // rep('Card')
        rep('Action')
        rep('Discard')
        // rep('Reload')

        c['text'] = c['text'].replace(/\+1 :Card:/g, `<span class="keyword">+1</span> <img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        c['text'] = c['text'].replace(/\+2 :Card:/g, `<span class="keyword">+2</span> <img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        c['text'] = c['text'].replace(/\+3 :Card:/g, `<span class="keyword">+3</span> <img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        c['text'] = c['text'].replace(/:Card:/g, `<img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        // c['text'] = c['text'].replace(/2 :Card:/g, `2 Cards`)
        // c['text'] = c['text'].replace(/3 :Card:/g, `3 Cards`)
        // c['text'] = c['text'].replace(/:Card:/g, `Card`)

        c['text'] = c['text'].replace(/\+1 :Reload:/g, `<span class="keyword">+1</span> <img class="rule-icon cycle" src="icons/cycle-2.svg" />`)
        c['text'] = c['text'].replace(/\+2 :Reload:/g, `<span class="keyword">+2</span> <img class="rule-icon cycle" src="icons/cycle-2.svg" />`)
        c['text'] = c['text'].replace(/:Reload:/g, `<img class="rule-icon cycle" src="icons/cycle-2.svg" />`)

        c['text'] = c['text'].replace(/:Hook:/g, `<img class="rule-icon hook-text" src="icons/hook-simplified.svg" />`)

        // c['text'] = c['text'].replace(/:Reload:/g, `Reload`)

        // c['text'] = c['text'].replace(/:Action:/g, `<img class="rule-icon star" src="icons/star.svg" />`)
        // c['text'] = c['text'].replace(/2 :Action:/g, `2 Actions`)
        // c['text'] = c['text'].replace(/5 :Action:/g, `5 Actions`)
        // c['text'] = c['text'].replace(/:Action:/g, `Action`)

        // c['text'] = c['text'].replace(/:Discard:/g, `Discard`)
        // c['text'] = c['text'].replace(/:Discard:/g, `<img class="rule-icon discard-t" src="icons/card-discard.svg" />`)


        var template = `
        <div class="card-container">
            <div class="card" id="card-${j}" title="${c['title']}">
                <div class="inner">
                    <div class="front type-${c['type']} ${c['class']}"> 
                        <div class="frame"><div></div></div>
                        <img src="${c['img']}" class="bg" />
                        
                        <span class="title">${c['title']}</span>
                        <span class="text" ${style}>
                            <span class="innerText">${c['text']}</span>
                            ${flavor}
                        </span>
                        ${extra}
                        

                        <div class="mpc">
                            <img src="pnp.png" />
                        </div>
                        <div class="mask"></div>
                    </div>
                    <div class="back">
                        <img src="back.png" />
                        <div class="mpc">
                            <img src="mpc.png" />
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="downloadCardButton(this)">Download #${j+1}, copies: ${c['amount']}</button><br>
            <label><input type="checkbox" id="check-pdf-${c['id']}" onclick="changePrintSelection(this)" data-card-id="${c['id']}"  ${c['pdf'] ? 'checked="true' : ''}">Part of print sheet</label>
        </div>
        `
        //<div class="proto">Proto. 0.9.29</div>
        all.push(template)
        j++;
    })

    // <img src="mpc-no-border.png" />

    document.getElementById('nbCards').innerHTML = amount;
    document.getElementById('nbDesign').innerHTML = cards.length;
    
    document.getElementById('distribution').innerHTML = JSON.stringify(distribution, undefined, '\n');

    document.getElementById('cards').innerHTML = all.join('')

    // do that once all the font are loaded
    setTimeout(() => {

        cards.forEach((c) => {
            if (c.type == 'rule' || c.type == 'coin') { return }
            var text = document.getElementById('card-'+c.id).querySelector('.innerText')
            // 5 lines
            var fs = 9;
            while(text.offsetHeight > 62.0) {
                fs -= 0.02;
                text.style['font-size'] = `${fs}px`
            }
        })

    }, 2000)


    var format = 'png'
    function updateFormat(e) {
        if (e.checked) {
            format = 'jpg'
        } else {
            format = 'png'
        }
    }

    var preparePrintClass = 'preparePrint';
    function outputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrint';
        } else { 
            preparePrintClass = 'preparePrintNotMPC';
        }
    }

    function PNPoutputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrintPNP';
        } else { 
            preparePrintClass = 'preparePrint';
        }
    }

    function download(url, title) {
        var a = document.createElement('a')
        a.href=url
        a.download=title+"."+format;
        document.body.appendChild(a)
        a.click()
        a.remove()
    }

    function changePrintSelection(e) {
        cards.forEach((card) => {
            if(card.id == parseInt(e.dataset.cardId, 10)) {
                card['pdf'] = e.checked
            }
        })
    }

    var zoom = 6.5
    function updateZoom(e) {
        zoom = parseFloat(e.value)
    }

    function downloadCardButton(e) {
        downloadCard(e.parentNode.querySelector('.card'))
    }

    function downloadCard(card, cb) {
        createCardImage(card, (canvas) => {
            var title = card.title.toLowerCase().replace(/\s/g, '-')
            if (format=='png') {
                img = canvas.toDataURL();
            } else {
                img = canvas.toDataURL("image/jpeg", 0.9)
            }
            download(img, title);
            console.log('download', title);
            cb && cb(title);
        })
    }

    function downloadBookletFace(id) {
        createBookletImage(document.getElementById(id || 'face'))
    }

    function downloadBookletBack(id) {
        createBookletImage(document.getElementById(id || 'back'))
    }

    function createCardImage(card, cb) {

        card.classList.add(preparePrintClass)
        cls = ""
        if (lang) {
            cls = 'class="lang-fr"'
        }

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0; background-color: transparent;}
                .card {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            <div ${cls}>
                ${card.outerHTML}
            </div>`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas)
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            card.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
            cb && cb(canvas)
        }, function error(e) {
            console.log("Error on card", card.title, e)
        });
    }

    function createBookletImage(booklet, cb) {
        
        booklet.classList.add(preparePrintClass)

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0}
                .booklet {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            
            ${booklet.outerHTML}`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            var title = booklet.title.toLowerCase().replace(/\s/g, '-')
            download(canvas.toDataURL(), title);
            booklet.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
        })

    }


var toRender = 0;

function bindImage(element, card, cb) {
    if (card['canvas']) {
        return cb();
    }
    createCardImage(element, (canvas) => {
        card['canvas'] = canvas
        cb();
    })
}

function selectAll() { 
    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        card.pdf = true;
        document.getElementById('check-pdf-'+card['id']).checked = true
    }
}

function downloadSelection(e) {
    e.disable = true;
    var previous = e.innerHTML
    toRender = 0;
    cards_to_render = {}
    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        downloadCard(e, () => {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    var inter = setInterval(() => {
        if (queue.length > 0) {
            if (queue.length > 0 || Object.keys(rendering).length > 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            return
        }
        clearInterval(inter);
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 2000)
    }, 1000);
}

function generatePrintSheet(e) {
    e.disable = true;
    var previous = e.innerHTML
    e.innerHTML = 'Please wait'
    toRender = 0;
    var jsPDF = window.jspdf.jsPDF;
    // A4
    var doc = new jsPDF({
        unit: "mm",
        format: [297, 210],
    });

    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        bindImage(e, card, ()=> {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    e.innerHTML = 'Rendering...'

    var inter = setInterval(() => {

        if (queue.length > 0 || Object.keys(rendering).length > 0) {
            if (Object.keys(rendering).length == 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            console.log(rendering, queue.length)
            return
        }

        clearInterval(inter);
        e.innerHTML = `Card render pass done, now PDF page rendering.`

        var pageCounter = 0;
        for (i=0; i<cards.length; i++) {
            var card = cards[i];
            if (!card.pdf) {
                continue
            }
            e.innerHTML = 'Rendering page ' + card['title'];
            for (j=0; j<card.amount; j++) {
                if (pageCounter > 8) {
                    doc.addPage()
                    pageCounter = 0;
                }

                // do not expect a lot of saved space using JPG
                var f = 'JPG'
                if (format=='png') {
                    f = 'PNG'
                }

                // printer need 8 mm margins

                

                var y = 10 + ((297 - 20) / 3.0) * Math.floor(pageCounter / 3.0)
                var x = 4 + ((210 - 10) / 3.0) * (pageCounter % 3);
                doc.addImage(card.canvas, f, x, y, 69.596, 94.996, card['title'], "FAST", 0)
                pageCounter += 1;
            }
        }

        doc.save("print.pdf");
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 500)
    }, 1000)
}

</script>
</html>