<html>
<head>
<meta charset="UTF-8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="design.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./rasterizeHTML.allinone.js"></script>
<script src="./cards.fr.js"></script>
<script src="./cards.en.js"></script>
<script src="./cards.es.js"></script>
</head>

<body>

<h2>DeckHand (v0.9.32)</h2>

<p>
    DeckHand is a pirate themed deck builder game for 2 to 4 players. There are <span id="nbCards"></span> cards in 
    the game with <span id="nbDesign"></span>  unique designs.
</p>

<div style="clear:both;padding-top:20px">

<div id="distribution"></div>
<!-- <button id="genPDF">Create MB Print compatible PDF</button> -->

</div>

<div style="display: flex;">
    <div class="booklet" id="face" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
                Set up for 2 to 4 players<span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 1/2</span>
            </h3>
         
        <ol>
            <li>Give each player 1 "Coins" and 1 "Coins Indicator" card and a <b>shuffled deck</b> of 2 "Fist Fight" and 2 "Celebrate". 
                Remove all remaining instances of these cards from the game.
            </li>
            <li>
                Shuffle the rest and create the <b>supply deck</b> with 11 cards per player. The remaining cards constitute the <b>reload deck</b>.
            </li>
            <li>
                Place 6 cards from the reload deck face up on the table to create the <b>supply</b>.
                Maintain 6 face-up supply cards <b>at all times</b> by replacing them from the <b>supply deck</b>.
            </li>
        </ol>

             <h3>Unfolding of the game</h3>

             <p style="margin-bottom: 4px;">
                A random player starts. Each player takes turns, following these steps:
             </p>
         
             <ol>
                <li>Resolve any start-of-turn effects that might trigger <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                <li>Discard <img class="rule-icon" src="icons/card-discard-yellow.svg" /> your hand, if any, then draw 3 cards from your deck.
                    From now on, your discard pile is referred to as the <b>stash</b>.
                </li>
                <li>You then have 2 Actions that you can use in the following ways:
                    <ul>
                        <li>Play a card from your hand: Set the card aside, resolve its effects and any consequences, and <b>then</b> put the card into your stash.</li>
                        <li>Buy a card from the supply: Pay the cost 
                             indicated by the chest <img class="rule-icon" src="icons/chest-simplified.svg" /> at the bottom right
                             with coins <img class="rule-icon coin" src="icons/coins.svg" /> and put it into your stash.</li>
                     </ul>
                </li>
             </ol>
             <p style="margin-top:5px">
                If your deck is ever empty during the game, <b>immediately</b> shuffle your stash 
                into a new deck and resume any ongoing actions or effects.
             </p>
            </div>

             <div style="margin-bottom: 18px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%;" />
                <div id="illustration" style="width:140px">
                    <div style="width:67px">
                        1. Supply deck<br>
                        2. Reload deck<br>
                        3. Supply
                    </div>
                    <div style="width:82px;">
                        4. Your hand<br>
                        5. Your deck</br>
                        6. Your stash
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="booklet" id="back"  title="booklet-back">
        <div class="innerBooklet">
            <div>
            <h3 style="margin-top:0">
                General rules <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 2/2</span>
            </h3>
        
            <p>Line up your stash cards facing upwards, allowing all players to quickly identify them.
                Do the same with your Coins cards.
            </p>
            <p>Resolve a card’s effect completely and step by step before taking other actions.
                If effects would trigger simultaneously, the initiator of 
                the first effect decides the order in which they are resolved.</p>
            <p>You can only discard cards from your hand. Revealing or looking at cards doesn't  
                add them to your hand or empties decks. Unless specified, revealed 
                cards return to their original position immediately.</p>
            <p>If an effect cannot be fully applied, it still applies partially, to the extent possible.
                However, You cannot select effects or targets that are not applicable.
                You must always own a minimum of 4 cards.</p>

            <p style="margin-top:3px;margin-bottom:3px"><b>Card text reference</b></p>
            
            <p><b>+1 <img class="rule-icon coin" src="icons/coins.svg" />:</b> Increase your coins by 1.</p>
            <p><b>+1 <img class="rule-icon draw" src="icons/card-draw-2.svg" />:</b> You may draw 1 card from your deck immediately.</p>
            <p><b>+1 <img class="rule-icon reload" src="icons/cycle-2.svg" />:</b> You may put 1 supply card at the bottom of the reload deck immediately. 
                If you do, replace it with a <b>reload deck</b> card.</p>
            <p><b>+1 Action:</b> Gain 1 extra Action to use this turn. Do not use more than 5 Actions per turn.</p>
            <p><b>+1 Buy:</b> You may Buy 1 card without using an Action this turn.</p>
            <p><b>Pay 1 <img class="rule-icon coin" src="icons/coins.svg" />:</b> Decrease your coins by 1.</p>
            <p><b>+1 Discard:</b> You must discard 1 card from your hand into your stash.</p>
        
            <h3>End of the game</h3>
        
            <p>
                The game ends when the supply deck is empty. 
                The current player finishes their turn, and the others take a final turn with only 1 starting Action.
                Count the number of hooks <img class="rule-icon" src="icons/hook-simplified.svg" /> in each deck. The player with the most
                hooks wins. In the case of a tie, the player with the most coins wins, followed by the player who ended the game.
            </p>

            </div>

            <div>
                How to play: https://bit.ly/dh-htp<br>
                News and Solo Challenges: https://bit.ly/dk-h
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace()">Download booklet face</button>
<button onclick="downloadBookletBack()">Download booklet back</button>


<div style="display: flex;">
    <div class="booklet booklet-fr" id="face-fr" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
                Mise en place pour 2 à 4 joueurs<span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Règles de DeckHand 1/2</span>
            </h3>
            
            <ol>
                <li>Donne à chaque joueur 1 carte "Pièces" et 1 carte "Indicateur de Pièces" 
                    ainsi qu'un <b>deck mélangé</b> de 2 "Bagarre" et 2 "Célébration". 
                    Retire toutes les autres occurrences de ces cartes du jeu.
                </li>
                <li>
                    Mélange le reste, et forme le <b>deck de réserve</b> avec 11 cartes par joueur. Les cartes restantes forment le <b>deck de recharge</b>.
                </li>
                <li>
                    Place 6 cartes du deck de recharge face visible sur la table comme <b>réserve</b>.
                    Maintient ces 6 cartes face visible à tout moment en les remplaçant depuis le <b>deck de réserve</b>.
                </li>
            </ol>
            
            <h3>Déroulement du jeu</h3>
            
            <p>
                Un joueur aléatoire démarre. Puis chacun, à leur tour, suit ces étapes:
            </p>
            
            <ol>
                <li>Résous les effets qui peuvent se produire au début du tour <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                <li>Défausse ta main <img class="rule-icon" src="icons/card-discard-yellow.svg" /> et pioche 3 cartes. Ta défausse se nomme désormais <b>planque</b>.</li>
                <li>Tu disposes de 2 Actions par tour, parmi lesquelles :
                    <ul>
                        <li>Jouer une carte : Mets la carte de coté, résous ses effets et conséquences <b>puis</b> mets-la dans ta planque.</li>
                        <li>Achète 1 carte de la réserve: Paie le coût en pièces <img class="rule-icon coin" src="icons/coins.svg" />  indiqué par le 
                            coffre <img class="rule-icon" src="icons/chest-simplified.svg" /> en bas à droite
                            puis mets-la dans ta planque.</li>
                    </ul>
                </li>
            </ol>

            <p style="margin-top:4px">
                Lorsque ton deck est vide, mélange <b>immédiatement</b> ta planque pour former un nouveau deck, 
                puis reprends tout action ou effet en cours.
            </p>

            </div>

            <div style="margin-bottom: 18px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%;" />
                <div id="illustration" style="width:160px">
                    <div style="width:75px">
                        1. Deck réserve<br>
                        2. Deck recharge<br>
                        3. Réserve
                    </div>
                    <div style="width:88px;">
                        4. Ta main<br>
                        5. Ton deck</br>
                        6. Ta planque
                    </div>
                </div>
            </div>
            
            <!-- <div style="margin-bottom: 20px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%" />
                <p id="illustration">
                    1. Deck réserve &nbsp;2. Deck recharge<br>
                    3. Réserve &nbsp;
                    4. Main + Trésors<br>
                    5. Ton deck &nbsp;
                    6. Ta défausse
                </p>
            </div> -->
        </div>
    </div>

    
    <div class="booklet booklet-fr" id="back-fr"  title="booklet-back">
        <div class="innerBooklet">
            <div>
                <h3 style="margin-top:0">
                    Règles générales <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Règles de DeckHand 2/2</span>
                </h3>
            
                <p>Aligne tes cartes de planque face visible, permettant aux joueurs de les identifier 
                    rapidement. Fais de même avec tes cartes Pièces.
                </p>
                <p>Résous l'effet d'une carte pas à pas avant de prendre d'autres actions. Si des effets se déclenchent simultanément,
                    l'initiateur du premier effet décide de l'ordre dans lequel ils sont résolus.
                </p>
                <p>Tu ne peux défausser que des cartes de ta main. Révéler ou regarder des cartes ne les place pas dans ta main 
                    ni ne vide un deck et, sauf mention contraire, elles retournent aussitôt à leur position d'origine.</p>
                <p>Si un effet ne peut pas être pleinement appliqué, il s'applique autant que possible. Évite 
                    cependant les effets ou cibles inapplicables. Tu ne peux pas posséder moins de 4 cartes.</p>

                <p style="margin-top:3px;margin-bottom:3px"><b>Référence pour le texte des cartes</b></p>

                <p><b>+1 <img class="rule-icon coin" src="icons/coins.svg" /> :</b> Augmente tes pièces de 1.</p>
                <p><b>+1 <img class="rule-icon draw" src="icons/card-draw-2.svg" /> :</b> Tu peux immédiatement piocher 1 carte de ton deck.</p>
                <p><b>+1 <img class="rule-icon reload" src="icons/cycle-2.svg" /> :</b> Tu peux immédiatement placer 1 carte de la réserve en bas 
                    du deck de recharge et la remplacer par une du <b>deck de recharge</b>.</p>
                <p><b>+1 Action :</b> Gagne 1 Action supplémentaire à utiliser plus tard ce tour. N'utilise pas plus de 5 Actions par tour.</p>
                <p><b>+1 Achat :</b> Achète 1 carte sans utiliser d'Action plus tard ce tour.</p>
                <p><b>Paye 1 <img class="rule-icon coin" src="icons/coins.svg" /> :</b> Diminue tes pièces de 1.</p>
                <p><b>+1 Défausse :</b> Défausse 1 carte de ta main dans ta planque.</p>

                <h3>Fin du jeu</h3>
                
                <p>
                    Le jeu se termine lorsque le deck de réserve est vide. Le joueur actuel termine son tour, et les autres joueurs
                    effectuent un dernier tour avec seulement 1 action de départ.
                    Comptez les crochets de chaque deck <img class="rule-icon" src="icons/hook.svg" />. Le joueur avec
                    le plus de crochets gagne. En cas d'égalité, celui ayant le plus de pièces gagne, suivi de celui qui a mis fin au jeu.
                </p>
            </div>
        
            <div>
                Comment jouer : https://bit.ly/dh-htp<br>
                Nouvelles et défis en solo : https://bit.ly/dk-h
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace('face-fr')">Download booklet face</button>
<button onclick="downloadBookletBack('back-fr')">Download booklet back</button>



<div style="display: flex;">
    <div class="booklet" id="face-es" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
               Preparación para 2 a 4 jugadores<span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Reglas DeckHand 1/2</span>
            </h3>
         
        <ol>
            <li>Reparte a cada jugador 1 carta "Moneda", 1 carta "Indicadora de Monedas" y un <b>mazo barajado</b> con 2 "Pelea a Puñetazos" y 2 "Celebraciones". 
                Elimina la instancia restante de esas cartas.
            </li>
            <li>
                Baraja el resto y crea el <b>mazo de suministro</b> con 11 cartas por jugador. Las cartas restantes forma el <b>mazo de recarga</b>.
            </li>
            <li>
                Coloca 6 cartas cara arriba del mazo de recarga para formar el <b>suministro</b>.
                Mantén <b>siempre</b> 6 cartas de suministro boca arriba reemplazándolas desde el <b>mazo de suministros</b>.
                <!-- <b>Siempre</b> tiene que haber 6 cartas, se reponen del <b>mazo de suministros</b>. -->
            </li>
        </ol>

             <h3>Desarrollo del Juego</h3>

             <p style="margin-bottom: 4px;">
                Un jugador al azar comienza. Luego, cada uno sigue estas etapas:
             </p>
         
             <ol>
                <li>Resuelve efectos que se desencadenen al inicio de turno <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                <li>Descarta <img class="rule-icon" src="icons/card-discard-yellow.svg" /> tu mano, si tienes, y roba 3 cartas de tu mazo.
                    A partir de ahora, tu pila de descarte se denominará <b>alijo</b>.
                </li>
                <li>Luego tienes 2 acciones que puedes usar de las siguientes maneras:
                    <ul>
                        <li>Jugar una carta de tu mano: Pon la carta a un lado, resuelve sus efectos y consecuencias, y <b>entonces</b> colocala en tu alijo.</li>
                        <li>Comprar una carta del suministro: Paga el coste 
                             indicado en el cofre <img class="rule-icon" src="icons/chest-simplified.svg" /> abajo a la derecha
                             con monedas <img class="rule-icon coin" src="icons/coins.svg" /> y colocalá en tu alijo.</li>
                     </ul>
                </li>
             </ol>
             <p style="margin-top:5px">
                Si tu mazo se agota durante el juego, <b>inmediatamente</b> baraja el alijo 
                para formar otra vez el mazo y reanudar cualquier acción o efecto.
             </p>
            </div>

             <div style="margin-bottom: 18px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%;" />
                <div id="illustration" style="width:140px;display:flex;">
                    <div style="width:90px">
                        1. Mazo Suministro<br>
                        2. Mazo Recarga<br>
                        3. Suministro
                    </div>
                    <div style="width:50px;">
                        4. Tu Mano<br>
                        5. Tu Mazo</br>
                        6. Tu Alijo
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="booklet" id="back-es"  title="booklet-back">
        <div class="innerBooklet">
            <div>
            <h3 style="margin-top:0">
                Reglas Generales <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Reglas DeckHand 2/2</span>
            </h3>
        
            <p>Coloca tus cartas de alijo cara arriba, permitiendo que todos las identifiquen rápidamente.
                Haz lo mismo con tus cartas de Monedas.
            </p>
            <p>Resuelve el efecto de una carta completamente antes de otras acciones.
                Si los efectos se desencadenaran simultáneamente, el iniciador de
                el primer efecto decide el orden de resolución.</p>
            <p>Sólo puedes descartar cartas de tu mano. Revelar o mirar cartas no
                las agrega a tu mano o vacía los mazos. A menos que se especifique,
                las cartas vuelven a su posición original inmediatamente.</p>
            <p>Si un efecto no se aplica completamente, se hace parcialmente en la medida de lo posible. 
                No puedes seleccionar efectos u objetivos no aplicables.
                Debes tener siempre un mínimo de 4 cartas.</p>

            <p style="margin-top:3px;margin-bottom:3px"><b>Referencia de texto en las Cartas</b></p>
            
            <p><b>+1 <img class="rule-icon coin" src="icons/coins.svg" />:</b> Incrementa tus monedas en 1.</p>
            <p><b>+1 <img class="rule-icon draw" src="icons/card-draw-2.svg" />:</b> Roba una carta de tu mazo.</p>
            <p><b>+1 <img class="rule-icon reload" src="icons/cycle-2.svg" />:</b> Coloca 1 carta de suministro en la parte inferior del mazo de recarga.
                Si lo haces, reemplázala con una del <b>mazo de recarga</b>.</p>
            <p><b>+1 Acción:</b> Gana una acción extra este turno. No puedes usar más de 5 Acciones.</p>
            <p><b>+1 Compra:</b> Compra una carta sin usar una Acción este turno.</p>
            <p><b>Paga 1 <img class="rule-icon coin" src="icons/coins.svg" />:</b> Reduce tus monedas en 1.</p>
            <p><b>+1 Descarte:</b> Descartar 1 carta de tu mano y ponla en tu Alijo.</p>
        
            <h3>Fin del Juego</h3>
        
            <p>
                El juego finaliza al acabarse el mazo de suministro. 
                El jugador actual finaliza su turno, y el resto realizan su turno solo con 1 Acción inicial.
                Cuenta el número de ganchos <img class="rule-icon" src="icons/hook-simplified.svg" /> en cada mazo. El jugador con más
                ganchos gana. En caso de empate, el jugador con más monedas gana, seguido por el jugador que finalizó el juego.
            </p>

            </div>

            <div>
                Como Jugar: https://bit.ly/dh-htp<br>
                Noticias y Retos en Solitario: https://bit.ly/dk-h
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace('face-es')">Download booklet face</button>
<button onclick="downloadBookletBack('back-es')">Download booklet back</button>



<p>
    <a href="./design.html">English</a>
    <a href="./design.html?lang=fr">French</a>    
    <a href="./design.html?lang=es">Spanish</a>    
</p>

<div class="config">
    General config
    <label>Use jpg<input type="checkbox" onchange="updateFormat(this)"></label>
    <label>Zoom<input type="text" value="6.5" onchange="updateZoom(this)"></label>
    <label>MPC image format<input type="checkbox" checked onchange="outputFormat(this)"></label>
    <label>PnP mask for easy cuts<input type="checkbox" onchange="PNPoutputFormat(this)"></label>
</div>


<!-- <div style="clear: both;">
    <img width="240" src="https://raw.githubusercontent.com/batiste/batiste.github.io/03451c0b33ddc125cb38a1750487a939a1397f1c/pirates-2/back.png">
    <img src="./back.png" width="240">
</div> -->

<p>
    <button onclick="selectAll(this)">Select All</button>
    <button onclick="generatePrintSheet(this)">Create Print Sheet PDF from selection</button>
    <button onclick="downloadSelection(this)">Download selection</button>
</p>

<div id="cards" class="lang-fr"></div>

<!-- class="lang-fr" -->

</body>

<script>


    all = []
    var j = 0;
    var amount = 0;
    var distribution = {'attack': 0, 'structure': 0, 'adventure': 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, nb_cards_necessary_total:(15 * 4 + 6 + 2)}

    var translations = cards.map(e => ({"title": e.title, "text": e.text, "flavor": e.flavor}))
    console.log(JSON.stringify(translations, null, 2))

    var lang = 'en';
    if (location.href.split('?').length > 1) {
        params = new URLSearchParams(location.href.split('?')[1])
        lang = params.get('lang')
    }
    var translation = {'fr': fr_translations, 'es': es_translations}
    var type_translation = {
        'en': {
            'attack': 'Attack',
            'adventure': 'Adventure',
            'structure': 'Structure',
            'character': 'Crew',
            'coin': 'Coin',
            'rule': 'Rules',
        },
        'fr': {
            'attack': 'Attaque',
            'adventure': 'Aventure',
            'structure': 'Structure',
            'character': 'Crew',
        },
        'es': {
            'attack': 'Ataque',
            'adventure': 'Aventura',
            'structure': 'Estructura',
            'character': 'Tripulación'
        }
    }

    cards.forEach((c) => {
        var extra = ""
        c['id'] = j;
        amount += c['amount'];

        if (lang && translation[lang]) {
            var t = translation[lang]
            if(t[j]) {
                c['title'] = t[j]['title']
                c['text'] = t[j]['text']
                c['flavor'] = t[j]['flavor']
                c['flavor-no-quotes'] = t[j]['flavor-no-quotes']
            }
        }

        if(j>1) {
            distribution[c['type']] += c['amount']
            distribution[c['cost']] += c['amount']
        }

        if(c['victory'] != undefined) {
            extra += `<span class="hook">${c['victory']}</span>
                <img class="hook-icon" src="icons/hook.svg" />`
        }

        if(c['cost'] != undefined) {
            extra += `<span class="cost">${c['cost']}</span>
                <img class="cost-icon" src="icons/chest.svg" />`
        }

        var type_trans = type_translation[lang][c['type']]
        if (c['extra_type']) {
            type_trans += ' - ' + type_translation[lang][c['extra_type']]
        }

        if(c['type'] != undefined) {
            var cls = "subtype"
            if(c['extra_type']) {
                cls += ' extra-subtype'
            }
            extra += `<span class="${cls}">${type_trans}</span>`
        }

        var top_left = '';
        var top_right = '';

        if(c['start'] != undefined) {
            top_left += `<span class="start"><img src="icons/bookmark-yellow.svg" /></span>`
        }

        if(c['discard'] != undefined) {
            top_left += `<span class="discard"><img src="icons/card-discard-yellow.svg" /></span>`
        }

        if(c['target'] != undefined) {
            top_left += `<span class="target"><img src="icons/target.svg" /></span>`
        }

        if(c['fist'] != undefined) {
            top_left += `<span class="fist"><img src="icons/fist.svg" /></span>`
        }

        if(c['coin'] != undefined) {
            top_left += `<span class="coin-top-left">${c['coin']}<img src="icons/coins.svg" /></span>`
        }

        if(c['flip'] != undefined) {
            top_right += `<span class="flip-top-right">${c['flip']}<img src="icons/coins.svg" /><img src="icons/right-arrow.svg" class="right-arrow" /></span>`
        }

        if (top_left) {
            extra += `<span class="top-left-icons-container">${top_left}</span>`
        }

        if (top_right) {
            extra += `<span class="top-right-icons-container">${top_right}</span>`
        }

        if(c['type'] == "attack") {
            extra += `<img class="attack-icon-1" src="icons/attack.svg" /><img class="attack-icon-2" src="icons/attack.svg" />`
        }

        if(c['type'] == "adventure") {
            extra += `<img class="tentacle-icon-1" src="icons/tentacle.svg" />`
            if(!c['extra_type']) {
                extra += `<img class="tentacle-icon-2" src="icons/tentacle.svg" />`
            }
        }

        if(c['type'] == "structure") {
            extra += `<img class="structure-icon-1" src="icons/structure.svg" />`
            if(!c['extra_type']) {
                extra += `<img class="structure-icon-2" src="icons/structure.svg" />`
            }
        }

        if(c['extra_type'] == 'adventure') {
            extra += `<img class="tentacle-icon-2" src="icons/tentacle.svg" />`
        }
        if(c['extra_type'] == 'attack') {
            extra += `<img class="attack-icon-2" src="icons/attack.svg" />`
        }
 
        var flavor = ""
        if(c['flavor']){
            flavor = `<span class="separator"></span><span class="flavour">“${c['flavor']}”</span>`
        }
        if(c['flavor-no-quotes']){
            flavor = `<span class="separator"></span><span class="flavour">${c['flavor-no-quotes']}</span>`
        }

        var style = ""
        if (c['reduced-font-size']) {
            style = `style="font-size: ${c['reduced-font-size']}"`
        }

        var or_txt = 'Or'
        if (lang == 'fr') {
            or_txt = 'Ou'
        }
        if (lang == 'es') {
            or_txt = 'O'
        }

        c['text'] = c['text'].replace(':d:', '<img class="rule-icon" src="icons/card-discard-yellow.svg">')
        c['text'] = c['text'].replace(':ms:', '<span class="mini-separator"></span>')
        c['text'] = c['text'].replace(':st:', '<img class="rule-icon" src="icons/bookmark-yellow.svg" />')
        c['text'] = c['text'].replace(':or:', `<span class="OR"><span class="or-line-left"></span>${or_txt}<span class="or-line-right"></span></span>`)
        

        function rep(key) {
            c['text'] = c['text'].replace(new RegExp(`\\+2 :${key}:`, 'g'), `<span class="keyword">+2 ${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`\\+3 :${key}:`, 'g'), `<span class="keyword">+3 ${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`4 :${key}:`, 'g'), `4 <span class="keyword">${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`5 :${key}:`, 'g'), `5 <span class="keyword">${key}s</span>`)
            c['text'] = c['text'].replace(new RegExp(`\\+1 :${key}:`, 'g'), `<span class="keyword">+1 ${key}</span>`)
            c['text'] = c['text'].replace(new RegExp(`:${key}:`, 'g'), `<span class="keyword">${key}</span>`)
        }

        c['text'] = c['text'].replace(/Pay 1 :Coin:/g, `<span class="keyword">Pay 1</span> <img class="rule-icon coin" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/Paye 1 :Coin:/g, `<span class="keyword">Paye 1</span> <img class="rule-icon coin" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/Paga 1 :Coin:/g, `<span class="keyword">Paga 1</span> <img class="rule-icon coin" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/\+1 :Buy:/g, `<span class="keyword">+1 Buy</span>`)
        c['text'] = c['text'].replace(/\+2 :Buy:/g, `<span class="keyword">+2 Buys</span>`)
        c['text'] = c['text'].replace(/\+1 :Achat:/g, `<span class="keyword">+1 Achat</span>`)
        c['text'] = c['text'].replace(/\+2 :Achat:/g, `<span class="keyword">+2 Achats</span>`)
        c['text'] = c['text'].replace(/\+1 :Compra:/g, `<span class="keyword">+1 Compra</span>`)
        c['text'] = c['text'].replace(/\+2 :Compra:/g, `<span class="keyword">+2 Compras</span>`)
        c['text'] = c['text'].replace(/\+1 :Descarte:/g, `<span class="keyword">+1 Descarte</span>`)
        c['text'] = c['text'].replace(/\+1 :Défausse:/g, `<span class="keyword">+1 Défausse</span>`)

        c['text'] = c['text'].replace(/\+1 :Accion:/g, `<span class="keyword">+1 Acción</span>`)
        c['text'] = c['text'].replace(/\+2 :Accion:/g, `<span class="keyword">+2 Acciones</span>`)
        c['text'] = c['text'].replace(/:Accion:/g, `<span class="keyword">Acción</span>`)

        c['text'] = c['text'].replace(/\+1 :Coin:/g, `<span class="keyword">+1</span> <img class="rule-icon coin" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/\+2 :Coin:/g, `<span class="keyword">+2</span> <img class="rule-icon coin" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/\+3 :Coin:/g, `<span class="keyword">+3</span> <img class="rule-icon coin" src="icons/coins.svg" />`)
        c['text'] = c['text'].replace(/:Coin:/g, `<img class="rule-icon coin" src="icons/coins.svg" />`)

        // rep('Card')
        rep('Action')
        rep('Discard')
        // rep('Défausse')
        // rep('Descarte')
        // rep('Reload')

        c['text'] = c['text'].replace(/\+1 :Card:/g, `<span class="keyword">+1</span> <img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        c['text'] = c['text'].replace(/\+2 :Card:/g, `<span class="keyword">+2</span> <img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        c['text'] = c['text'].replace(/\+3 :Card:/g, `<span class="keyword">+3</span> <img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        c['text'] = c['text'].replace(/:Card:/g, `<img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        // c['text'] = c['text'].replace(/2 :Card:/g, `2 Cards`)
        // c['text'] = c['text'].replace(/3 :Card:/g, `3 Cards`)
        // c['text'] = c['text'].replace(/:Card:/g, `Card`)

        c['text'] = c['text'].replace(/\+1 :Reload:/g, `<span class="keyword">+1</span> <img class="rule-icon cycle" src="icons/cycle-2.svg" />`)
        c['text'] = c['text'].replace(/\+2 :Reload:/g, `<span class="keyword">+2</span> <img class="rule-icon cycle" src="icons/cycle-2.svg" />`)
        c['text'] = c['text'].replace(/:Reload:/g, `<img class="rule-icon cycle" src="icons/cycle-2.svg" />`)

        c['text'] = c['text'].replace(/:Hook:/g, `<img class="rule-icon hook-text" src="icons/hook-simplified.svg" />`)

        // c['text'] = c['text'].replace(/:Reload:/g, `Reload`)

        // c['text'] = c['text'].replace(/:Action:/g, `<img class="rule-icon star" src="icons/star.svg" />`)
        // c['text'] = c['text'].replace(/2 :Action:/g, `2 Actions`)
        // c['text'] = c['text'].replace(/5 :Action:/g, `5 Actions`)
        // c['text'] = c['text'].replace(/:Action:/g, `Action`)

        // c['text'] = c['text'].replace(/:Discard:/g, `Discard`)
        // c['text'] = c['text'].replace(/:Discard:/g, `<img class="rule-icon discard-t" src="icons/card-discard.svg" />`)


        var template = `
        <div class="card-container">
            <div class="card" id="card-${j}" title="${c['title']}">
                <div class="inner">
                    <div class="front type-${c['type']} ${c['class']}"> 
                        <div class="frame"><div></div></div>
                        <img src="${c['img']}" class="bg" />
                        
                        <span class="title">${c['title']}</span>
                        <span class="text" ${style}>
                            <span class="innerText">${c['text']}</span>
                            ${flavor}
                        </span>
                        ${extra}
                        

                        <div class="mpc">
                            <img src="pnp.png" />
                        </div>
                        <div class="mask"></div>
                    </div>
                    <div class="back">
                        <img src="back.png" />
                        <div class="mpc">
                            <img src="mpc.png" />
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="downloadCardButton(this)">Download #${j+1}, copies: ${c['amount']}</button><br>
            <label><input type="checkbox" id="check-pdf-${c['id']}" onclick="changePrintSelection(this)" data-card-id="${c['id']}"  ${c['pdf'] ? 'checked="true' : ''}">Part of print sheet</label>
        </div>
        `
        //<div class="proto">Proto. 0.9.29</div>
        all.push(template)
        j++;
    })

    // <img src="mpc-no-border.png" />

    document.getElementById('nbCards').innerHTML = amount;
    document.getElementById('nbDesign').innerHTML = cards.length;
    
    document.getElementById('distribution').innerHTML = JSON.stringify(distribution, undefined, '\n');

    document.getElementById('cards').innerHTML = all.join('')

    // do that once all the font are loaded
    setTimeout(() => {

        cards.forEach((c) => {
            if (c.type == 'rule' || c.type == 'coin' || c.type == "indicator" || c.type == "treasure") { return }
            var text = document.getElementById('card-'+c.id).querySelector('.innerText')
            // 5 lines
            var fs = 9;
            var limit = 62.0;
            if(c.type == 'character') {
                limit = 69.0;
            }

            while(text.offsetHeight > limit) {
                fs -= 0.02;
                text.style['font-size'] = `${fs}px`
            }
        })

    }, 2000)


    var format = 'png'
    function updateFormat(e) {
        if (e.checked) {
            format = 'jpg'
        } else {
            format = 'png'
        }
    }

    var preparePrintClass = 'preparePrint';
    function outputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrint';
        } else { 
            preparePrintClass = 'preparePrintNotMPC';
        }
    }

    function PNPoutputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrintPNP';
        } else { 
            preparePrintClass = 'preparePrint';
        }
    }

    function download(url, title) {
        var a = document.createElement('a')
        a.href=url
        a.download=title+"."+format;
        document.body.appendChild(a)
        a.click()
        a.remove()
    }

    function changePrintSelection(e) {
        cards.forEach((card) => {
            if(card.id == parseInt(e.dataset.cardId, 10)) {
                card['pdf'] = e.checked
            }
        })
    }

    var zoom = 6.5
    function updateZoom(e) {
        zoom = parseFloat(e.value)
    }

    function downloadCardButton(e) {
        downloadCard(e.parentNode.querySelector('.card'))
    }

    function downloadCard(card, cb) {
        createCardImage(card, (canvas) => {
            var title = card.title.toLowerCase().replace(/\s/g, '-')
            if (format=='png') {
                img = canvas.toDataURL();
            } else {
                img = canvas.toDataURL("image/jpeg", 0.9)
            }
            download(img, title);
            console.log('download', title);
            cb && cb(title);
        })
    }

    function downloadBookletFace(id) {
        createBookletImage(document.getElementById(id || 'face'))
    }

    function downloadBookletBack(id) {
        createBookletImage(document.getElementById(id || 'back'))
    }

    function createCardImage(card, cb) {

        card.classList.add(preparePrintClass)
        cls = ""
        if (lang) {
            cls = 'class="lang-fr"'
        }

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0; background-color: transparent;}
                .card {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            <div ${cls}>
                ${card.outerHTML}
            </div>`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas)
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            card.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
            cb && cb(canvas)
        }, function error(e) {
            console.log("Error on card", card.title, e)
        });
    }

    function createBookletImage(booklet, cb) {
        
        booklet.classList.add(preparePrintClass)

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0}
                .booklet {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            
            ${booklet.outerHTML}`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            var title = booklet.title.toLowerCase().replace(/\s/g, '-')
            download(canvas.toDataURL(), title);
            booklet.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
        })

    }


var toRender = 0;

function bindImage(element, card, cb) {
    if (card['canvas']) {
        return cb();
    }
    createCardImage(element, (canvas) => {
        card['canvas'] = canvas
        cb();
    })
}

function selectAll() { 
    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        card.pdf = true;
        document.getElementById('check-pdf-'+card['id']).checked = true
    }
}

function downloadSelection(e) {
    e.disable = true;
    var previous = e.innerHTML
    toRender = 0;
    cards_to_render = {}
    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        downloadCard(e, () => {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    var inter = setInterval(() => {
        if (queue.length > 0) {
            if (queue.length > 0 || Object.keys(rendering).length > 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            return
        }
        clearInterval(inter);
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 2000)
    }, 1000);
}

function generatePrintSheet(e) {
    e.disable = true;
    var previous = e.innerHTML
    e.innerHTML = 'Please wait'
    toRender = 0;
    var jsPDF = window.jspdf.jsPDF;
    // A4
    var doc = new jsPDF({
        unit: "mm",
        format: [297, 210],
    });

    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        bindImage(e, card, ()=> {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    e.innerHTML = 'Rendering...'

    var inter = setInterval(() => {

        if (queue.length > 0 || Object.keys(rendering).length > 0) {
            if (Object.keys(rendering).length == 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            console.log(rendering, queue.length)
            return
        }

        clearInterval(inter);
        e.innerHTML = `Card render pass done, now PDF page rendering.`

        var pageCounter = 0;
        for (i=0; i<cards.length; i++) {
            var card = cards[i];
            if (!card.pdf) {
                continue
            }
            e.innerHTML = 'Rendering page ' + card['title'];
            for (j=0; j<card.amount; j++) {
                if (pageCounter > 8) {
                    doc.addPage()
                    pageCounter = 0;
                }

                // do not expect a lot of saved space using JPG
                var f = 'JPG'
                if (format=='png') {
                    f = 'PNG'
                }

                // printer need 8 mm margins

                

                var y = 10 + ((297 - 20) / 3.0) * Math.floor(pageCounter / 3.0)
                var x = 4 + ((210 - 10) / 3.0) * (pageCounter % 3);
                doc.addImage(card.canvas, f, x, y, 69.596, 94.996, card['title'], "FAST", 0)
                pageCounter += 1;
            }
        }

        doc.save("print.pdf");
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 500)
    }, 1000)
}

</script>
</html>