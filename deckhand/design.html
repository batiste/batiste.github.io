<html>
<head>
<meta charset="UTF-8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="design.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./rasterizeHTML.allinone.js"></script>
<script src="./cards.fr.js"></script>
<script src="./cards.en.js"></script>
</head>

<body>

<h2>DeckHand (v0.9.32)</h2>

<p>
    DeckHand is a pirate themed deck builder game for 2 to 4 players. There are <span id="nbCards"></span> cards in 
    the game with <span id="nbDesign"></span>  unique designs.
</p>

<div style="clear:both;padding-top:20px">

<div id="distribution"></div>
<!-- <button id="genPDF">Create MB Print compatible PDF</button> -->

</div>

<div style="display: flex;">
    <div class="booklet" id="face" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
                Set up for 2 to 4 players<span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 1/2</span>
            </h3>
         
             <ol>
                <li>Gather about 20 Treasure tokens into a bank. We recommend using tokens instead of dice. Distribute 1 Treasure 
                    <img class="rule-icon" src="icons/chest-simplified.svg" /> to each player.
                </li>
                <!-- <li>
                    To play a novice game (3 players max.), remove all card with the :Hard: from the game.
                </li> -->
                <li>
                    Each player gets a shuffled deck of 2 "Fist Fight" and 2 "Celebrate".
                    Remove all other "Fist Fight" and "Celebrate" from the game.
                </li>
                <li>
                    Shuffle and create the <b>supply deck</b> with 11 cards per player (10 with 4 players). The remaining cards constitute the <b>reload deck</b>.
                </li>
                <li>
                    Place 6 cards from the reload deck face up on the table to create the supply.
                    From now on, maintain 6 face-up cards by replacing them from the <b>supply deck</b>.
                 </li>
             </ol>

             <h3>Unfolding of the game</h3>

             <p>
                A random player starts. Each player in turn follow those steps:
             </p>
         
             <ol>
                 <li>Apply effects that happen at the start of your turn <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                 <li>Discard your hand <img class="rule-icon star" src="icons/card-discard.svg" /> and draw 3 cards <img class="rule-icon" src="icons/card-draw-2.svg" />. 
                    Your discard pile is named the <b>stash</b>.</li>
                 <li>During your turn, you have 2 Actions <img class="rule-icon star" src="icons/star.svg" />, which can be:
                     <ol>
                         <li>Playing a card: Apply its effects <b>then</b> put the card in your stash.</li>
                         <li>Buying a card from the supply: Pay the cost <img class="rule-icon" src="icons/chest-simplified.svg" />
                             indicated at the bottom right of the card and put it in your stash.</li>
                     </ol>
                  </li>
                 <li>When your deck is empty, <b>immediately</b> shuffle your stash into a new deck, then resume any ongoing effect.
                 </li>
             </ol>
            </div>

             <div style="margin-bottom: 20px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%" />
                <p id="illustration">
                    1. Supply deck &nbsp;2. Reload deck<br>
                    3. Supply &nbsp;
                    4. Hand and Treasures<br>
                    5. Your deck &nbsp;
                    6. Your stash
                </p>
            </div>
        </div>
    </div>
    <div class="booklet" id="back"  title="booklet-back">
        <div class="innerBooklet">
            <div>
            <h3 style="margin-top:0">
                General rules <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">DeckHand Rules 2/2</span>
            </h3>
        
            <ol>
                <li>The hook icon on the bottom left <img class="rule-icon" src="icons/hook.svg" /> 
                    indicates the victory points.</li>
                <li><img class="rule-icon" src="icons/card-discard-yellow.svg" />&nbsp;<img class="rule-icon" src="icons/bookmark-yellow.svg" /> Icons at the top left are reminders of triggered effects.
                    </li>
                <li><img class="rule-icon" src="icons/target.svg" /> Indicates targeted effects that affect enemies.</li>
                <li><b>+1 <img class="rule-icon" src="icons/chest-simplified.svg" />:</b> Take a Treasure from the bank immediately.</li>
                <li><b>+1 <img class="rule-icon" src="icons/card-draw-2.svg" />:</b> Draw a card from your deck immediately.</li>
                <li><b>+1 <img class="rule-icon star" src="icons/star.svg" />:</b> Gain an extra Action to use later this turn.</li>
                <li><b>+1 <img class="rule-icon star" src="icons/cycle-2.svg" />:</b> You may put 1 supply card at the bottom of the reload deck immediately or later this turn. 
                    Replace it with a <b>reload deck</b> card.</li>
                <li><b>+1 Buy:</b> Buy a card without using an Action later this turn.</li>
                <li><b>+1 <img class="rule-icon star" src="icons/card-discard.svg" />:</b> Discard a card immediately into your stash.</li>
                <li>Pay 1 <img class="rule-icon" src="icons/chest-simplified.svg" />: Put one of your Treasures into the bank.</li>
                <li>While being played, cards are not in your hand or stash.</li>
                <li>Apply card effects <b>in the written order</b>. If effects would trigger at the same time, the initiator of the first effect chooses the order.</li>
                <!-- You may only gain and use <img class="rule-icon star" src="icons/star.svg" />, <img class="rule-icon star" src="icons/cycle-2.svg" /> or Buys during your turn. -->
                <!-- <li>Cards have 3 possible types: Attack, Structure, Adventure.</li> -->
                <li>Arrange your stash face up to allow for examination at a glance. You can only Discard cards from your hand.</li>
                <li>Unless specified, revealed cards return to their original position <b>immediately</b>. 
                    Revealing cards never empties a deck.</li>
                <li>If a deck/stash/hand is too small for an effect, it applies to any nonzero amount. 
                    You cannot own fewer than 4 cards.</li>
            </ol>
        
            <h3>End of the game</h3>
        
            <p>
                The game ends when the supply deck is empty. The current player finishes their turn, and the others
                take a final turn with only 1 starting Action.
                Count the number of hooks in each deck <img class="rule-icon" src="icons/hook.svg" />. The player with 
                the most hooks wins. In case of a tie, the one with the most Treasures wins, followed by the one who ended the game.
            </p>

            </div>

            <p>Simplified game (3 players max.): Remove all cards marked with <img class="rule-icon" src="icons/chest-simplified.svg" /></p>

            <div>
                Information and update: https://bit.ly/dk-h<br>
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace()">Download booklet face</button>
<button onclick="downloadBookletBack()">Download booklet back</button>


<div style="display: flex;">
    <div class="booklet booklet-fr" id="face-fr" title="booklet-face">
        <div class="innerBooklet">     
            <div>
            <h3 style="margin-top:0">
                Mise en place pour 2 à 4 joueurs<span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Règles de DeckHand 1/2</span>
            </h3>
            
            <ol>
                <li>Rassemble 20 jetons de Trésor dans une banque. Donne 1 Trésor à chaque joueur.</li>
                <li>
                    Chaque joueur reçoit un deck de 2 Bagarre et 2 Célébration.
                    Retire toutes les autres cartes Bagarre et Célébration du jeu.
                </li>
                <li>
                    Mélange et forme le deck de réserve avec 11 cartes par joueur (10 avec 4 joueurs). Les autres cartes forment le deck de recharge.
                </li>
                <li>
                    Place 6 cartes du deck de recharge face visible sur la table comme réserve.
                    À partir de maintenant, maintient 6 cartes face visible en les remplaçant depuis le deck de la <b>réserve</b>.
                </li>
            </ol>
            
            <h3>Déroulement du jeu</h3>
            
            <p>
                Un joueur débute au hasard, puis chacun son tour et dans l'ordre :
            </p>
            
            <ol>
                <li>Applique les effets qui se produisent au début du tour <img class="rule-icon" src="icons/bookmark-yellow.svg" />.</li>
                <li>Défausse ta main <img class="rule-icon" src="icons/card-discard-yellow.svg" /> et pioche 3 cartes.</li>
                <li>Tu disposes de 2 Actions par tour, parmi lesquelles :
                    <ol>
                        <li>Jouer une carte : Active ses effets <b>puis</b> mets-la dans ta défausse.</li>
                        <li>Acheter une carte de la réserve : Elle est mise dans ta défausse.</li>
                    </ol>
                </li>
                <li>Lorsque ton deck est vide, mélange <b>immédiatement</b> ta défausse pour former un nouveau deck, puis reprent tout effet en cours.
                </li>
            </ol>
            </div>
            
            <div style="margin-bottom: 20px; position: relative;">
                <img src="marketing/board.png" width="102%" style="margin-left: -1%" />
                <p id="illustration">
                    1. Deck réserve &nbsp;2. Deck recharge<br>
                    3. Réserve &nbsp;
                    4. Main + Trésors<br>
                    5. Ton deck &nbsp;
                    6. Ta défausse
                </p>
            </div>
        </div>
    </div>
    <div class="booklet booklet-fr" id="back-fr"  title="booklet-back">
        <div class="innerBooklet">
            <div>
                <h3 style="margin-top:0">
                    Règles générales <span style="float: right; font-size: 10px; margin-top: -4px; margin-right: -2px;">Règles de DeckHand 2/2</span>
                </h3>
            
                <ol>
                    <li>Les Trésors sont la monnaie pour acheter des cartes de la réserve. Le coût est indiqué
                        par l'icône de coffre en bas à droite <img class="rule-icon" src="icons/chest.svg" />.
                        L'icône de crochet en bas à gauche <img class="rule-icon" src="icons/hook.svg" /> indique les points de victoire.</li>
                    <li><img class="rule-icon" src="icons/card-discard-yellow.svg" />&nbsp;<img class="rule-icon" src="icons/bookmark-yellow.svg" /> 
                        Les icônes en haut à gauche sont des effets déclenchés.</li>
                    <li><img class="rule-icon" src="icons/target.svg" /> Indique des effets ciblés qui affectent les ennemis..</li>
                    <li><b>+1 Trésor :</b> Prends immédiatement 1 Trésor de la banque.</li>
                    <li><b>+1 Carte :</b> Pioche immédiatement une carte de ton deck.</li>
                    <li><b>+1 Action :</b> Tu as droit à 1 Action de plus ce tour-ci.</li>
                    <li><b>+1 Achat :</b> Tu peux acheter 1 carte sans utiliser d'action ce tour-ci.</li>
                    <li><b>+1 Recharge :</b> Tu peux mettre 1 carte de la réserve en bas du deck recharge ce tour-ci.
                        Remplace-la par 1 carte du deck <b>recharge</b>.</li>
                    <li>+1 Défausse : Défausse immédiatement une carte <img class="rule-icon" src="icons/card-discard-yellow.svg" />.</li>
                    <li>Applique les effets des cartes <b>dans l'ordre écrit</b>. 
                        Acquiers et utilise Action, Achat, ou Recharge seulement durant ton tour.</li>
                    <li>Une carte étant jouée n'est ni en main ni en défausse.</li>
                    <!-- <li>Les cartes ont 3 types possibles : Attaque, Structure, Aventure.</li> -->
                    <!-- <li>Le texte disant "vous avez" fait référence aux cartes se trouvant dans votre main.</li> -->
                    <li>Tu ne peux défausser que des cartes de ta main.
                        <!-- Jouer n'est pas Défausser. -->
                        Dispose ta pile de défausse face visible afin de permettre un examen rapide.</li>
                    <!-- <li>Si un effet ne contient pas le mot clé "cible", rien n'est ciblé.</li> -->
                    <li>Sauf spécification contraire, les cartes révélées retournent à leur place d'origine <b>immédiatement</b>.
                        Révéler ne vide jamais un deck.</li>
                    <li>Si le deck/main/défausse est trop petit pour un effet, applique-le à toute quantité non nulle. Tu ne peux pas avoir moins de 4 cartes.</li> <!-- ; tout effet tentant de le faire est annulé. -->
                </ol>

                <h3>Fin du jeu</h3>
                
                <p>
                    Le jeu se termine lorsque le deck de réserve est vide. Le joueur actuel termine son tour, et les autres joueurs
                    effectuent un dernier tour avec seulement 1 action de départ.
                    Compte les crochets de chaque deck <img class="rule-icon" src="icons/hook.svg" />. Le joueur avec
                    le plus de crochets gagne. En cas d'égalité, celui ayant le plus de Trésors gagne, suivi de celui qui a mis fin au jeu.
                </p>
            </div>
        
            <!-- <p><b>Challenge en solo</b> : Créez un deck de réserve de 22 cartes et retirez une carte à chaque tour.
                Visez à atteindre 30 points de victoire.</p> -->
        
            <div>
                Informations et mises à jour : https://bit.ly/dk-h<br>
            </div>
        </div>
    </div>
</div>

<button onclick="downloadBookletFace('face-fr')">Download booklet face</button>
<button onclick="downloadBookletBack('back-fr')">Download booklet back</button>


<p>
    <a href="./design.html">English</a>
    <a href="./design.html?lang=fr">French</a>    
</p>

<div class="config">
    General config
    <label>Use jpg<input type="checkbox" onchange="updateFormat(this)"></label>
    <label>Zoom<input type="text" value="6.5" onchange="updateZoom(this)"></label>
    <label>MPC image format<input type="checkbox" checked onchange="outputFormat(this)"></label>
</div>


<!-- <div style="clear: both;">
    <img width="240" src="https://raw.githubusercontent.com/batiste/batiste.github.io/03451c0b33ddc125cb38a1750487a939a1397f1c/pirates-2/back.png">
    <img src="./back.png" width="240">
</div> -->

<p>
    <button onclick="selectAll(this)">Select All</button>
    <button onclick="generatePrintSheet(this)">Create Print Sheet PDF from selection</button>
    <button onclick="downloadSelection(this)">Download selection</button>
</p>

<div id="cards" class="lang-fr"></div>

<!-- class="lang-fr" -->

</body>

<script>


    all = []
    var j = 0;
    var amount = 0;
    var distribution = {'attack': 0, 'structure': 0, 'adventure': 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, nb_cards_necessary_total:(15 * 4 + 6 + 2)}

    var translations = cards.map(e => ({"title": e.title, "text": e.text, "flavor": e.flavor}))
    console.log(JSON.stringify(translations, null, 2))

    var lang = 'en';
    if (location.href.split('?').length > 1) {
        params = new URLSearchParams(location.href.split('?')[1])
        lang = params.get('lang')
    }
    var translation = {'fr': fr_translations}
    var type_translation = {
        'en': {
            'attack': 'Attack',
            'adventure': 'Adventure',
            'structure': 'Structure',
        },
        'fr': {
            'attack': 'Attaque',
            'adventure': 'Aventure',
            'structure': 'Structure',
        }
    }

    cards.forEach((c) => {
        var extra = ""
        c['id'] = j;
        amount += c['amount'];

        if (lang && translation[lang]) {
            var t = translation[lang]
            c['title'] = t[j]['title']
            c['text'] = t[j]['text']
            c['flavor'] = t[j]['flavor']
            c['flavor-no-quotes'] = t[j]['flavor-no-quotes']
        }

        if(j>1) {
            distribution[c['type']] += c['amount']
            distribution[c['cost']] += c['amount']
        }

        if(c['victory'] != undefined) {
            extra += `<span class="hook">${c['victory']}</span>
                <img class="hook-icon" src="icons/hook.svg" />`
        }

        if(c['cost'] != undefined) {
            extra += `<span class="cost">${c['cost']}</span>
                <img class="cost-icon" src="icons/chest.svg" />`
        }

        if(c['type'] != undefined) {
            extra += `<span class="subtype">${type_translation[lang][c['type']]}</span>`
        }

        var top_left = '';

        if(c['start'] != undefined) {
            top_left += `<span class="start"><img src="icons/bookmark-yellow.svg" /></span>`
        }

        if(c['discard'] != undefined) {
            top_left += `<span class="discard"><img src="icons/card-discard-yellow.svg" /></span>`
        }

        if(c['target'] != undefined) {
            top_left += `<span class="target"><img src="icons/target.svg" /></span>`
        }

        if (top_left) {
            extra += `<span class="top-left-icons-container">${top_left}</span>`
        }

        if(c['type'] == "attack") {
            extra += `<img class="attack-icon-1" src="icons/attack.svg" /><img class="attack-icon-2" src="icons/attack.svg" />`
        }

        if(c['type'] == "adventure") {
            extra += `<img class="tentacle-icon-1" src="icons/tentacle.svg" /><img class="tentacle-icon-2" src="icons/tentacle.svg" />`
        }

        if(c['type'] == "structure") {
            extra += `<img class="structure-icon-1" src="icons/structure.svg" /><img class="structure-icon-2" src="icons/structure.svg" />`
        }

        var flavor = ""
        if(c['flavor']){
            flavor = `<span class="separator"></span><span class="flavour">“${c['flavor']}”</span>`
        }
        if(c['flavor-no-quotes']){
            flavor = `<span class="separator"></span><span class="flavour">${c['flavor-no-quotes']}</span>`
        }

        var style = ""
        if (c['reduced-font-size']) {
            style = `style="font-size: ${c['reduced-font-size']}"`
        }

        var or_txt = 'Or'
        if (lang == 'fr') {
            or_txt = 'Ou'
        }

        c['text'] = c['text'].replace(':d:', '<img class="rule-icon" src="icons/card-discard-yellow.svg">')
        c['text'] = c['text'].replace(':ms:', '<span class="mini-separator"></span>')
        c['text'] = c['text'].replace(':st:', '<img class="rule-icon" src="icons/bookmark-yellow.svg" />')
        c['text'] = c['text'].replace(':or:', `<span class="OR"><span class="or-line-left"></span>${or_txt}<span class="or-line-right"></span></span>`)

        c['text'] = c['text'].replace(/:Treasure:/g, `<img class="rule-icon chest" src="icons/chest-simplified.svg" />`)
        // c['text'] = c['text'].replace(/Treasure/g, `<img class="rule-icon chest" src="icons/chest.svg" />`)

        c['text'] = c['text'].replace(/:Card:/g, `<img class="rule-icon draw" src="icons/card-draw-2.svg" />`)
        // c['text'] = c['text'].replace(/Card/g, `<img class="rule-icon draw" src="icons/card-draw-2.svg" />`)

        // c['text'] = c['text'].replace(/Reloads/g, `<img class="rule-icon cycle" src="icons/cycle-2.svg" />`)
        c['text'] = c['text'].replace(/:Reload:/g, `<img class="rule-icon cycle" src="icons/cycle-2.svg" />`)

        c['text'] = c['text'].replace(/:Action:/g, `<img class="rule-icon star" src="icons/star.svg" />`)
        // c['text'] = c['text'].replace(/Action/g, `<img class="rule-icon star" src="icons/star.svg" />`)

        // c['text'] = c['text'].replace(/Buys/g, `<img class="rule-icon buy" src="icons/buy.svg" />`)
        // c['text'] = c['text'].replace(/Buy/g, `<img class="rule-icon buy" src="icons/buy.svg" />`)

        // c['text'] = c['text'].replace(/Discarded/g, `---`)

        c['text'] = c['text'].replace(/:Discard:/g, `<img class="rule-icon discard-t" src="icons/card-discard.svg" />`)
        // c['text'] = c['text'].replace(/Discard/g, `<img class="rule-icon discard-t" src="icons/card-discard.svg" />`)

        // c['text'] = c['text'].replace(/---/g, `Discarded`)

        var template = `
        <div class="card-container">
            <div class="card" id="card-${j}" title="${c['title']}">
                <div class="inner">
                    <div class="front type-${c['type']}"> 
                        <div class="frame"><div></div></div>
                        <img src="${c['img']}" class="bg" />
                        
                        <span class="title">${c['title']}</span>
                        <span class="text" ${style}>
                            <span class="innerText">${c['text']}</span>
                            ${flavor}
                        </span>
                        ${extra}
                        

                        <div class="mpc">
                            <img src="mpc-no-border.png" />
                        </div>
                        <div class="mask"></div>
                    </div>
                    <div class="back">
                        <img src="back.png" />
                        <div class="mpc">
                            <img src="mpc.png" />
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="downloadCardButton(this)">Download #${j+1}, copies: ${c['amount']}</button><br>
            <label><input type="checkbox" id="check-pdf-${c['id']}" onclick="changePrintSelection(this)" data-card-id="${c['id']}"  ${c['pdf'] ? 'checked="true' : ''}">Part of print sheet</label>
        </div>
        `
        //<div class="proto">Proto. 0.9.29</div>
        all.push(template)
        j++;
    })

    document.getElementById('nbCards').innerHTML = amount;
    document.getElementById('nbDesign').innerHTML = cards.length;
    
    document.getElementById('distribution').innerHTML = JSON.stringify(distribution, undefined, '\n');

    document.getElementById('cards').innerHTML = all.join('')

    // do that once all the font are loaded
    setTimeout(() => {
        document.querySelectorAll('.innerText').forEach((text) => {
            // 5 lines
            var fs = 9;
            while(text.offsetHeight > 62.0) {
                fs -= 0.02;
                text.style['font-size'] = `${fs}px`
            }
        })
    }, 2000)


    var format = 'png'
    function updateFormat(e) {
        if (e.checked) {
            format = 'jpg'
        } else {
            format = 'png'
        }
    }

    var preparePrintClass = 'preparePrint';
    function outputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrint';
        } else { 
            preparePrintClass = 'preparePrintNotMPC';
        }
    }

    function download(url, title) {
        var a = document.createElement('a')
        a.href=url
        a.download=title+"."+format;
        document.body.appendChild(a)
        a.click()
        a.remove()
    }

    function changePrintSelection(e) {
        cards.forEach((card) => {
            if(card.id == parseInt(e.dataset.cardId, 10)) {
                card['pdf'] = e.checked
            }
        })
    }

    var zoom = 6.5
    function updateZoom(e) {
        zoom = parseFloat(e.value)
    }

    function downloadCardButton(e) {
        downloadCard(e.parentNode.querySelector('.card'))
    }

    function downloadCard(card, cb) {
        createCardImage(card, (canvas) => {
            var title = card.title.toLowerCase().replace(/\s/g, '-')
            if (format=='png') {
                img = canvas.toDataURL();
            } else {
                img = canvas.toDataURL("image/jpeg", 0.9)
            }
            download(img, title);
            console.log('download', title);
            cb && cb(title);
        })
    }

    function downloadBookletFace(id) {
        createBookletImage(document.getElementById(id || 'face'))
    }

    function downloadBookletBack(id) {
        createBookletImage(document.getElementById(id || 'back'))
    }

    function createCardImage(card, cb) {

        card.classList.add(preparePrintClass)
        cls = ""
        if (lang) {
            cls = 'class="lang-fr"'
        }

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0; background-color: transparent;}
                .card {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            <div ${cls}>
                ${card.outerHTML}
            </div>`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas)
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            card.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
            cb && cb(canvas)
        }, function error(e) {
            console.log("Error on card", card.title, e)
        });
    }

    function createBookletImage(booklet, cb) {
        
        booklet.classList.add(preparePrintClass)

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0}
                .booklet {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            
            ${booklet.outerHTML}`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            var title = booklet.title.toLowerCase().replace(/\s/g, '-')
            download(canvas.toDataURL(), title);
            booklet.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
        })

    }


var toRender = 0;

function bindImage(element, card, cb) {
    if (card['canvas']) {
        return cb();
    }
    createCardImage(element, (canvas) => {
        card['canvas'] = canvas
        cb();
    })
}

function selectAll() { 
    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        card.pdf = true;
        document.getElementById('check-pdf-'+card['id']).checked = true
    }
}

function downloadSelection(e) {
    e.disable = true;
    var previous = e.innerHTML
    toRender = 0;
    cards_to_render = {}
    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        downloadCard(e, () => {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    var inter = setInterval(() => {
        if (queue.length > 0) {
            if (queue.length > 0 || Object.keys(rendering).length > 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            return
        }
        clearInterval(inter);
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 2000)
    }, 1000);
}

function generatePrintSheet(e) {
    e.disable = true;
    var previous = e.innerHTML
    e.innerHTML = 'Please wait'
    toRender = 0;
    var jsPDF = window.jspdf.jsPDF;
    // A4
    var doc = new jsPDF({
        unit: "mm",
        format: [297, 210],
    });

    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        bindImage(e, card, ()=> {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    e.innerHTML = 'Rendering...'

    var inter = setInterval(() => {

        if (queue.length > 0 || Object.keys(rendering).length > 0) {
            if (Object.keys(rendering).length == 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            console.log(rendering, queue.length)
            return
        }

        clearInterval(inter);
        e.innerHTML = `Card render pass done, now PDF page rendering.`

        var pageCounter = 0;
        for (i=0; i<cards.length; i++) {
            var card = cards[i];
            if (!card.pdf) {
                continue
            }
            e.innerHTML = 'Rendering page ' + card['title'];
            for (j=0; j<card.amount; j++) {
                if (pageCounter > 8) {
                    doc.addPage()
                    pageCounter = 0;
                }

                var y = (297 / 3.0) * Math.floor(pageCounter / 3.0)
                var x = (210 / 3.0) * (pageCounter % 3);
                doc.addImage(card.canvas, "PNG", x, y, 69, 94, card['title'], "FAST", 0)
                pageCounter += 1;
            }
        }

        doc.save("print.pdf");
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 500)
    }, 1000)
}

</script>
</html>