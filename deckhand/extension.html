<html>
<head>
<meta charset="UTF-8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="design.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./rasterizeHTML.allinone.js"></script>
<script src="./cards.fr.js"></script>
<script src="./cards.en.js"></script>
<script src="./cards.es.js"></script>
</head>

<body>

<h2>DeckHand (v0.9.32)</h2>

<p>
    DeckHand is a pirate themed deck builder game for 2 to 4 players. There are <span id="nbCards"></span> cards in 
    the game with <span id="nbDesign"></span>  unique designs.
</p>


<div class="config">
    General config
    <label>Use jpg<input type="checkbox" onchange="updateFormat(this)"></label>
    <label>Zoom<input type="text" value="6.5" onchange="updateZoom(this)"></label>
    <label>MPC image format<input type="checkbox" checked onchange="outputFormat(this)"></label>
    <label>PnP mask for easy cuts<input type="checkbox" onchange="PNPoutputFormat(this)"></label>
</div>


<!-- <div style="clear: both;">
    <img width="240" src="https://raw.githubusercontent.com/batiste/batiste.github.io/03451c0b33ddc125cb38a1750487a939a1397f1c/pirates-2/back.png">
    <img src="./back.png" width="240">
</div> -->

<p>
    <button onclick="selectAll(this)">Select All</button>
    <button onclick="generatePrintSheet(this)">Create Print Sheet PDF from selection</button>
    <button onclick="downloadSelection(this)">Download selection</button>
</p>


<!-- class="lang-fr" -->

<style>
    .mission .frame {
        background: url(marketing/booklet.png);
        background-size: cover;
        right: 6mm;
        top: 41mm;
        left: 6mm;
        bottom: 6mm;
    }
    .mission .text {
        color: #000
    }
    .mission .innerText .rule-icon {
        background-color: #000;
    }
    .mission .title {
        color: #212121;
        text-shadow: none;
        top: 44mm;
    }
    .mission .text {
        color: #212121;
        text-shadow: none;
        top: 42mm;
    }
    .mission .left, .mission .right {
        text-align: left;
        padding: 3.5px 8px;
    }
    .mission .right {
        width: auto;
        padding-left: 2px;
    }
    .mission .left {
        width: 48%;
        background: url(ext/actions.png);
        background-size: cover;
        background-position: right;
        border-radius: 3px;
    }
    .actions {
        display: flex;
        border: 1px #a38030 solid;
        border-radius: 3px;
        margin-top: -1px;
    }
    .new-cost {
        position:absolute;
        right: 9mm;
        bottom: 8mm;
        display: flex;
        height:30px;
        color: #000;
        align-items: center;
        font-family: 'Lobster Two', cursive;
        font-size: 15px;
    }
    .new-cost img {
        margin: 4px;
        margin-right: 4px;
        margin-left: 9px;
    }
    .card .text .coin {
        margin-left: 0px;
        padding: 1px;
    }
</style>


<div id="cards" class="lang-fr">

<div class="card-container mission">
    <div class="card" id="card-3" title="Fist Fight">
        <div class="inner">
            <div class="front type-attack"> 
                <div class="frame"></div>
                <img src="adventures/spice-trade.png" class="bg">
                
                <span class="title">Trade Routes</span>
                <span class="text">
                    <span class="innerText">
                        <div style="margin-bottom: 5px">When you gain Sovereignty over Trade Route: <b>+1 Buy</b></div>
                        <div class="actions">
                            <span class="left"><b>+2 Discard</b></span>
                            <span class="right"><b>+1 <img class="rule-icon coin" src="icons/coins.svg" /></b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b>Pay 1 <img class="rule-icon coin" src="icons/coins.svg" /></b></span>
                            <span class="right"><b>+ 1 Buy</b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b></b></span>
                            <span class="right"><b>+1 <img class="rule-icon" src="icons/tentacle.svg" /></b></span>
                        </div>
                        
                    </span>
                </span>
            </div>
        <div class="new-cost">
            <img src="icons/tentacle.svg"> 4
            <img src="icons/chest.svg" style="background-color: #000; border-radius: 3px; padding: 1px"> 1
        </div>

        </div>
    </div>
    <button onclick="downloadCardButton(this)">Download #4, copies: 8</button><br>
</div>


<div class="card-container mission">
    <div class="card" id="card-3" title="Fist Fight">
        <div class="inner">
            <div class="front type-attack"> 
                <div class="frame"></div>
                <img src="adventures/spice-trade.png" class="bg">
                
                <span class="title">Mercenaries</span>
                <span class="text">
                    <span class="innerText">
                        <div style="margin-bottom: 5px"></div>
                        <div class="actions">
                            <span class="left"><b>Pay 2 <img class="rule-icon coin" src="icons/coins.svg" /></b></span>
                            <span class="right"><b>+1 Action</b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b>Play 2 <img class="rule-icon" src="icons/attack.svg" /></b></span>
                            <span class="right"><b>+2 <img class="rule-icon" src="icons/attack.svg" /></b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b>+1 Discard</b></span>
                            <span class="right"><b>+1 <img class="rule-icon cycle" src="icons/cycle-2.svg" /></b></span>
                        </div>
                        
                    </span>
                </span>
            </div>
        <div class="new-cost">
            <img src="icons/attack.svg"> 4
            <img src="icons/chest.svg" style="background-color: #000; border-radius: 3px; padding: 1px"> 1
        </div>

        </div>
    </div>
    <button onclick="downloadCardButton(this)">Download #4, copies: 8</button><br>
</div>


<div class="card-container mission">
    <div class="card" id="card-3" title="Fist Fight">
        <div class="inner">
            <div class="front type-attack"> 
                <div class="frame"></div>
                <img src="adventures/spice-trade.png" class="bg">
                
                <span class="title">Sawmill</span>
                <span class="text">
                    <span class="innerText">
                        <div style="margin-bottom: 5px"></div>
                        <div class="actions">
                            <span class="left"><b>Pay 1 <img class="rule-icon coin" src="icons/coins.svg" /></b></span>
                            <span class="right"><b>+1 Buy</b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b>+1 Discard</b></span>
                            <span class="right"><b>+2 <img class="rule-icon" src="icons/structure.svg" /></b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b>Play 1 <img class="rule-icon" src="icons/structure.svg" /></b></span>
                            <span class="right"><b>+2 <img class="rule-icon cycle" src="icons/cycle-2.svg" /></b></span>
                        </div>
                        
                    </span>
                </span>
            </div>
        <div class="new-cost">
            <img src="icons/structure.svg"> 2
            <img src="icons/chest.svg" style="background-color: #000; border-radius: 3px; padding: 1px"> 1
        </div>

        </div>
    </div>
    <button onclick="downloadCardButton(this)">Download #4, copies: 8</button><br>
</div>




<div class="card-container mission">
    <div class="card" id="card-3" title="Fist Fight">
        <div class="inner">
            <div class="front type-attack"> 
                <div class="frame"></div>
                <img src="adventures/spice-trade.png" class="bg">
                
                <span class="title">Imperial Reserve</span>
                <span class="text">
                    <span class="innerText">
                        <div style="margin-bottom: 5px"></div>
                        <div class="actions">
                            <span class="left"><b>Pay 3 <img class="rule-icon coin" src="icons/coins.svg" /></b></span>
                            <span class="right"><b>+4 <img class="rule-icon coin" src="icons/coins.svg" /></b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b>Play 2 <img class="rule-icon" src="icons/structure.svg" /></b></span>
                            <span class="right"><b>+1 Action</b></span>
                        </div>
                        <div class="actions">
                            <span class="left"><b>3 <img class="rule-icon" src="icons/structure.svg" /></b></span>
                            <span class="right"><b>+1 Draw</b></span>
                        </div>
                        
                    </span>
                </span>
            </div>
        <div class="new-cost">
            <img src="icons/attack.svg"> 2
            <img src="icons/structure.svg"> 4
            <img src="icons/chest.svg" style="background-color: #000; border-radius: 3px; padding: 1px"> 2
        </div>

        </div>
    </div>
    <button onclick="downloadCardButton(this)">Download #4, copies: 8</button><br>
    <label><input type="checkbox" id="check-pdf-3" onclick="changePrintSelection(this)" data-card-id="3" "="">Part of print sheet</label>
</div>



</div>

</body>

<script>


    var format = 'png'
    function updateFormat(e) {
        if (e.checked) {
            format = 'jpg'
        } else {
            format = 'png'
        }
    }

    var preparePrintClass = 'preparePrint';
    function outputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrint';
        } else { 
            preparePrintClass = 'preparePrintNotMPC';
        }
    }

    function PNPoutputFormat(e) {
        if (e.checked) { 
            preparePrintClass = 'preparePrintPNP';
        } else { 
            preparePrintClass = 'preparePrint';
        }
    }

    function download(url, title) {
        var a = document.createElement('a')
        a.href=url
        a.download=title+"."+format;
        document.body.appendChild(a)
        a.click()
        a.remove()
    }

    function changePrintSelection(e) {
        cards.forEach((card) => {
            if(card.id == parseInt(e.dataset.cardId, 10)) {
                card['pdf'] = e.checked
            }
        })
    }

    var zoom = 6.5
    function updateZoom(e) {
        zoom = parseFloat(e.value)
    }

    function downloadCardButton(e) {
        downloadCard(e.parentNode.querySelector('.card'))
    }

    function downloadCard(card, cb) {
        createCardImage(card, (canvas) => {
            var title = card.title.toLowerCase().replace(/\s/g, '-')
            if (format=='png') {
                img = canvas.toDataURL();
            } else {
                img = canvas.toDataURL("image/jpeg", 0.9)
            }
            download(img, title);
            console.log('download', title);
            cb && cb(title);
        })
    }

    function downloadBookletFace(id) {
        createBookletImage(document.getElementById(id || 'face'))
    }

    function downloadBookletBack(id) {
        createBookletImage(document.getElementById(id || 'back'))
    }

    function createCardImage(card, cb) {

        card.classList.add(preparePrintClass)
        cls = ""
        if (lang) {
            cls = 'class="lang-fr"'
        }

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0; background-color: transparent;}
                .card {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            <div ${cls}>
                ${card.outerHTML}
            </div>`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas)
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            card.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
            cb && cb(canvas)
        }, function error(e) {
            console.log("Error on card", card.title, e)
        });
    }

    function createBookletImage(booklet, cb) {
        
        booklet.classList.add(preparePrintClass)

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="design.css">
            <style>
                html, body {margin:0; padding:0}
                .booklet {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            
            ${booklet.outerHTML}`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            var title = booklet.title.toLowerCase().replace(/\s/g, '-')
            download(canvas.toDataURL(), title);
            booklet.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
        })

    }


var toRender = 0;

function bindImage(element, card, cb) {
    if (card['canvas']) {
        return cb();
    }
    createCardImage(element, (canvas) => {
        card['canvas'] = canvas
        cb();
    })
}

function selectAll() { 
    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        card.pdf = true;
        document.getElementById('check-pdf-'+card['id']).checked = true
    }
}

function downloadSelection(e) {
    e.disable = true;
    var previous = e.innerHTML
    toRender = 0;
    cards_to_render = {}
    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        downloadCard(e, () => {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    var inter = setInterval(() => {
        if (queue.length > 0) {
            if (queue.length > 0 || Object.keys(rendering).length > 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            return
        }
        clearInterval(inter);
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 2000)
    }, 1000);
}

function generatePrintSheet(e) {
    e.disable = true;
    var previous = e.innerHTML
    e.innerHTML = 'Please wait'
    toRender = 0;
    var jsPDF = window.jspdf.jsPDF;
    // A4
    var doc = new jsPDF({
        unit: "mm",
        format: [297, 210],
    });

    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        bindImage(e, card, ()=> {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    e.innerHTML = 'Rendering...'

    var inter = setInterval(() => {

        if (queue.length > 0 || Object.keys(rendering).length > 0) {
            if (Object.keys(rendering).length == 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            console.log(rendering, queue.length)
            return
        }

        clearInterval(inter);
        e.innerHTML = `Card render pass done, now PDF page rendering.`

        var pageCounter = 0;
        for (i=0; i<cards.length; i++) {
            var card = cards[i];
            if (!card.pdf) {
                continue
            }
            e.innerHTML = 'Rendering page ' + card['title'];
            for (j=0; j<card.amount; j++) {
                if (pageCounter > 8) {
                    doc.addPage()
                    pageCounter = 0;
                }

                // do not expect a lot of saved space using JPG
                var f = 'JPG'
                if (format=='png') {
                    f = 'PNG'
                }

                // printer need 8 mm margins

                

                var y = 10 + ((297 - 20) / 3.0) * Math.floor(pageCounter / 3.0)
                var x = 4 + ((210 - 10) / 3.0) * (pageCounter % 3);
                doc.addImage(card.canvas, f, x, y, 69.596, 94.996, card['title'], "FAST", 0)
                pageCounter += 1;
            }
        }

        doc.save("print.pdf");
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 500)
    }, 1000)
}

</script>
</html>