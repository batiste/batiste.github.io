<html>
<head>
<meta charset="UTF-8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="2.css">
<script src="./cards.en.js"></script>
<script src="../deckhand/rasterizeHTML.allinone.js"></script>
</head>

<body>

<h2>DeckHand 2</h2>


<div class="config">
    General config
    <label>Use jpg<input type="checkbox" onchange="updateFormat(this)"></label>
    <label>Zoom<input type="text" value="6.5" onchange="updateZoom(this)"></label>
</div>


<!-- <div style="clear: both;">
    <img width="240" src="https://raw.githubusercontent.com/batiste/batiste.github.io/03451c0b33ddc125cb38a1750487a939a1397f1c/pirates-2/back-character.jpg">
    <img src="./back-character.jpg" width="240">
</div> -->

<p>
    <button onclick="selectAll(this)">Select All</button>
    <button onclick="downloadSelection(this)">Download selection</button>
</p>


<!-- class="lang-fr" -->

<style>



</style>


<div id="cards" class="lang-fr">

</div>




</div>

</body>

<script>


var i = 1;
var cards_total = "";
var res = (t) => `
    <div class="resource">
        <img src="img/${t}.png">
    </div>
    `

var get_res = (r) => {
    if (r == "p") {
        return res("parrot")
    }
    if (r == "c") {
        return res("coin")
    }
    if (r == "cs") {
        return res("silver")
    }
    if (r == "g") {
        return res("gun")
    }
    if (r == "r") {
        return res("rum")
    }
    if (r == "e") {
        return res("gem")
    }
    if (r == "m") {
        return res("purse")
    }
    if (r == "s") {
        return res("skull")
    }
    if (r == "h") {
        return res("helm")
    }
    if (r == "gem") {
        return res("gem")
    }
    if (r == "produce") {
        return res("arrow")
    }
    if (r == "discard-1") {
        return res("draw-1")
    }
    if (r == "x") {
        return `<div class="mult" style="font-weight: bold; color: #fff">X</div>`
    }
    if (r == "t") {
        return res("purse")
    }
    if (r == "or") {
        return `<b style="font-size:18px;color:#000c">|</b>`
    }
}

var stats_costs = {};
var stats_discard = {};
var stats_vp = {};
var production_type = ['r', 's', 'g', 'p', 'h', 'c', 'e', 'cs']
var stats_production = {}
cards.forEach((c) => {
    c.cost.forEach((co) => {
        stats_costs[co] = 1 + (stats_costs[co] || 0);
    });
    stats_discard[c.discard[0]] = 1 + (stats_discard[c.discard[0]] || 0);
    if (c.extra) {
        c.extra.forEach(g => {
            stats_vp[g] = 1 + (stats_vp[g] || 0);
        })
    }
    if (c.production) {
        var add = 1;
        if (c.production.length == 3) {
            var add = c.production[1] == "trans" ? 0.5 : 1;
        }
        c.production.forEach(t => {
            stats_production[t] = add + (stats_production[t] || 0)
        })
    }
});

console.log('stats_costs', stats_costs)
console.log('stats_discard', stats_discard)
console.log('stats_vp', stats_vp)
console.log('stats_production', stats_production)

var icon = (t) => {
    return `<img src="img/${t}.png" class="${t} icon">`
}

var virtual_cost = {
    "c": 1.2,
    "cs": 0.8,
    "g": 1.9, // justification: easier to get
    "p": 1.9,
    "r": 1.9,
    "s": 2.8, // justification: you can always discard 2 cards to get it
    "h": 2.8,
    "e": 2.8,
}

// how many of those symbols are expected to exist in the end
// game on a board, without pushing it too much
var distribution_end_game = {
    "c": 0.5,
    "g": 3,
    "p": 3,
    "r": 3,
    "s": 2,
    "h": 2,
    "e": 2,
    "cs": 2,
}

var get_v_cost = (s) => {
    return virtual_cost[s] || 0;
}

var virtual_value = {
    "c": 4,
    "cs": 1.5,
    "g": 2,
    "p": 2,
    "r": 2,
    "s": 3,
    "h": 3,
}

var evaluate_production = (prod) => {
    if (!prod) {
        return 0;
    }
    var bits = prod;
    if (bits.length == 1) {
        return virtual_value[bits[0]]
    }
    if (bits.length == 3) {
        if (bits[1] == "or") {
            // very minus here because of the distribution bonus
            return virtual_value[bits[0]] + virtual_value[bits[2]] - 0.1;
        }
        if (bits[1] == "trans") {
            return virtual_value[bits[2]] - 1.5;
        }
    }
    return 0
}

var get_v_value = (c) => {
    var v = 0;
    if(c.extra && c.extra.length) {
        if (c.extra[0] == "bolt") {
            v = 0.3;
        } else {
            var vp = parseInt(c.extra[0].split('-')[1]);
            if(c.extra.length == 3 && c.extra[1] == 'x') {
                v = vp * distribution_end_game[c.extra[2]]
            } else {
                v += vp;
            }
        }
    }

    // the card itself has a value of 1
    var v_cost = 1;
    if (c.cost) {
        c.cost.forEach((co) => {
            v_cost += get_v_cost(co)
        })
    }
    c.v_cost = Math.round(10.0 * v_cost) / 10.0;
    console.log(c.title)
    c.v_value = v + evaluate_production(c.production);
    c.v_ratio = Math.round((100.0 * c.v_value) / parseFloat(c.v_cost)) / 100.0;
}


var replace_icons = (txt) => {
    txt = txt.replace(/hammer/g, icon('hammer'))
    txt = txt.replace(/gun/g, icon('gun'))
    txt = txt.replace(/parrot/g, icon('parrot'))
    txt = txt.replace(/rum-guild/g, icon('rum-guild'))
    txt = txt.replace(/gun-guild/g, icon('gun-guild'))
    txt = txt.replace(/parrot-guild/g, icon('parrot-guild'))
    txt = txt.replace(/skull-guild/g, icon('skull-guild'))
    txt = txt.replace(/gem/g, icon('gem'))
    txt = txt.replace(/rum/g, icon('rum'))
    txt = txt.replace(/coin/g, icon('coin'))
    txt = txt.replace(/silver/g, icon('silver'))
    txt = txt.replace(/trans/g, icon('arrow'))
    txt = txt.replace(/draw-1/g, icon('draw-1'))
    txt = txt.replace(/skull/g, icon('skull'))
    txt = txt.replace(/draw-2/g, icon('draw-2'))
    txt = txt.replace(/helm/g, icon('helm'))
    txt = txt.replace(/crate/g, icon('crate'))
    txt = txt.replace(/bolt/g, icon('bolt'))
    txt = txt.replace(/or/g, `<b style="font-size:18px;color:#000c">|</b>`)
    txt = txt.replace(/vp-2/g, icon('vp-2'))
    return txt
}

cards.forEach((c) => {

    var cost = "";
    var v_cost = 0
    if (c.cost) {
        c.cost.forEach((co) => {
            cost += get_res(co)
        })
        if (cost) {
            cost = `<div class="price-tag">${cost}</div>`
        }
    }

    var guild = ''
    if (c.extra) {
        c.extra.forEach(c => {
            if (c == "r") {
                guild += `<img class="res" src="img/rum.png">`
            }
            if (c == "p") {
                guild += `<img class="res" src="img/parrot.png">`
            }
            if (c == "g") {
                guild += `<img class="res" src="img/gun.png">`
            }
            if (c == "cs") {
                guild += `<img class="res" src="img/silver.png">`
            }
            if (c == "bolt") {
                guild += `<img class="res" src="img/bolt.png">`
            }
            if (c.startsWith('vp-')) {
                guild += `<img src="img/${c}.png">`
            }
            if (c == "crate") {
                guild += `<img src="img/crate.png">`
            }
            if (c == "h") {
                guild += `<img class="res" src="img/helm.png">`
            }
            if (c == "s") {
                guild += `<img class="res" src="img/skull.png">`
            }
            if (c == "e") {
                guild += `<img class="res" src="img/gem.png">`
            }
            if (c == "x") {
                guild += `<img class="cross" src="img/cross.png">`
            }
        })

        if (guild) {
            guild = `<div class="guild">${guild}</div>`
        }
    }

    var build = "";
    var production = ""
    if (c.production) {
        c.production.forEach(p => {
            production += get_res(p)
        })
    }
    production = `<div class="build_text">${production}</div>`
    build = `<div class="type line">
            ${guild}
            ${production}
            <div class="resources">${build}</div>
        </div>`


    var title_class = "";
    var split_title = c.title;
    if (split_title.length > 14) {
        title_class = "large_title"
    }
    if (split_title.split(" ").length > 1) {
        split_title = "<span>" + c.title.split(" ").join("</span> <span>") + "</span>"
    }

    var dis = ""
    if (c.discard) {
        c.discard.forEach(d => {
            dis += get_res(d)
        })
    }

    var cp = '';
    if(c.captain) {
        cp = '<img class="captain" src="img/arrow-left.png">';
    }

    get_v_value(c);
    if(c.v_ratio > 0.69999) {
        c.v_ratio = `<b class="op">${c.v_ratio}</b>`
    }
    if(c.v_ratio < 0.5) {
        c.v_ratio = `<b class="up">${c.v_ratio}</b>`
    }


    var card_template = `
    <div>
        <div class="card type-${c.type || ""}" title="${c.title}" id="card-${i}">
            <div class="inner">
                
                ${cost}
                ${cp}

                <div class="top-bar">
                    <span class="discard">${dis}</span>
                </div>

                <div class="bg">
                    <img src="${c.img}">
                </div>

                <div class="bottom">
                    ${build}
                </div>
                
                <div class="mpc"></div>
                <span class="title ${title_class}">${split_title}</span>
            </div>
        </div>
        <button onclick="downloadCardButton(this)">Download #${i} </button><br>
        cost: ${c.v_cost}, value: ${c.v_value}, ratio: ${c.v_ratio};<br>
        <label><input type="checkbox" id="check-pdf-${i}" 
                onclick="changePrintSelection(this)" data-card-id="${i}">Part of print sheet</label>
    </div>
    `

    cards_total += card_template;
    c.id = i;
    i++;
})

document.getElementById('cards').innerHTML = cards_total;

</script>



<script>

    var lang = 'en';


    var format = 'png'
    function updateFormat(e) {
        if (e.checked) {
            format = 'jpg'
        } else {
            format = 'png'
        }
    }

    var preparePrintClass = 'preparePrint';

    function download(url, title) {
        var a = document.createElement('a')
        a.href=url
        a.download=title+"."+format;
        document.body.appendChild(a)
        a.click()
        a.remove()
    }

    function changePrintSelection(e) {
        cards.forEach((card) => {
            if(card.id == parseInt(e.dataset.cardId, 10)) {
                card['pdf'] = e.checked
            }
        })
    }

    var zoom = 3.16
    function updateZoom(e) {
        zoom = parseFloat(e.value)
    }

    function downloadCardButton(e) {
        downloadCard(e.parentNode.querySelector('.card'))
    }

    function downloadCard(card, cb) {
        createCardImage(card, (canvas) => {
            var title = card.title.toLowerCase().replace(/\s/g, '-')
            if (format=='png') {
                img = canvas.toDataURL();
            } else {
                img = canvas.toDataURL("image/jpeg", 0.9)
            }
            download(img, title);
            cb && cb(title);
        })
    }

    function downloadBookletFace(id) {
        createBookletImage(document.getElementById(id || 'face'))
    }

    function downloadBookletBack(id) {
        createBookletImage(document.getElementById(id || 'back'))
    }

    function createCardImage(card, cb) {

        card.classList.add(preparePrintClass)
        cls = ""
        if (lang) {
            cls = 'class="lang-fr"'
        }

        var h = `
            <link href="https://fonts.googleapis.com/css2?family=Della+Respira&family=Lobster+Two:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
            <link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="2.css">
            <style>
                html, body {margin:0; padding:0; background-color: transparent;}
                .card {zoom: ${zoom}; float: none; position: initial; margin: 0;}
            </style>
            <div ${cls}>
                ${card.outerHTML}
            </div>`

        rasterizeHTML.drawHTML(h, null).then(function success(renderResult) {
            img = renderResult.image;
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            document.body.appendChild(canvas)
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0)
            card.classList.remove(preparePrintClass)
            canvas.parentNode.removeChild(canvas)
            cb && cb(canvas)
        }, function error(e) {
            console.log("Error on card", card.title, e)
        });
    }

var toRender = 0;

function bindImage(element, card, cb) {
    if (card['canvas']) {
        return cb();
    }
    createCardImage(element, (canvas) => {
        card['canvas'] = canvas
        cb();
    })
}

function selectAll() { 
    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        card.pdf = true;
        document.getElementById('check-pdf-'+card['id']).checked = true
    }
}

function downloadSelection(e) {
    e.disable = true;
    var previous = e.innerHTML
    toRender = 0;
    cards_to_render = {}
    queue = []
    rendering = {}

    e.innerHTML = 'Rendering..., please wait, it might take a while.'

    for (i=0; i<cards.length; i++) {
        var card = cards[i];
        if (card.pdf) {
            toRender = toRender + 1;
            queue.push(card)
        }
    }

    function render(card) {
        rendering[card.title] = card
        var e = document.getElementById('card-'+card['id'])
        downloadCard(e, () => {
            delete rendering[card.title];
            toRender = toRender - 1;
        })
    }

    var inter = setInterval(() => {
        if (queue.length > 0) {
            if (queue.length > 0 || Object.keys(rendering).length > 0) {
                c = queue.pop();
                render(c)
            }
            e.innerHTML = `Starting rendering of cards (${toRender}).`
            return
        }
        clearInterval(inter);
        e.innerHTML = 'Done!'
        setTimeout(() => {
            e.innerHTML = previous;
        }, 2000)
    }, 1000);
}


</script>
</html>